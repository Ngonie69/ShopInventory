@using System.Globalization

<MudDatePicker Label="@Label" Editable="true" Date="_date" ImmediateText="true" Placeholder="@Placeholder"
    DateFormat="@_dateFormat" TextChanged="DatePickerTextChanged" Clearable="true" Variant="@Variant" Margin="@Margin"
    Class="@Class" Disabled="@Disabled" Required="@Required" HelperText="@HelperText" />

@code {
    [Parameter] public string Label { get; set; } = "Date";
    [Parameter] public DateTime? Date { get; set; }
    [Parameter] public EventCallback<DateTime?> DateChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "dd.MM.yyyy";
    [Parameter] public Variant Variant { get; set; } = Variant.Outlined;
    [Parameter] public Margin Margin { get; set; } = Margin.Dense;
    [Parameter] public string? Class { get; set; }
    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public bool Required { get; set; } = false;
    [Parameter] public string? HelperText { get; set; }

    private DateTime? _date;
    private string _dateFormat = "dd.MM.yyyy";

    protected override void OnParametersSet()
    {
        _date = Date;
    }

    private async Task DatePickerTextChanged(string value)
    {
        if (string.IsNullOrEmpty(value) || value.Length < 6)
        {
            _date = null;
        }
        else
        {
            string[] formats = {
"ddMMyy",
"ddMMyyyy",
"dd.MM.yyyy",
"dd.M.yyyy",
"d.MM.yyyy",
"d.M.yyyy",
"dd.MM.yy",
"dd.M.yy",
"d.MM.yy",
"d.M.yy",
"dd/MM/yyyy",
"dd/M/yyyy",
"d/MM/yyyy",
"d/M/yyyy",
"dd/MM/yy",
"dd/M/yy",
"d/MM/yy",
"d/M/yy",
"dd-MM-yyyy",
"dd-M-yyyy",
"d-MM-yyyy",
"d-M-yyyy",
"dd-MM-yy",
"dd-M-yy",
"d-MM-yy",
"d-M-yy",
"yyyy-MM-dd"
};

            if (DateTime.TryParseExact(value, formats, CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime validDate))
            {
                _date = validDate;
            }
            else
            {
                _date = null;
            }
        }

        if (_date != Date)
        {
            await DateChanged.InvokeAsync(_date);
        }
    }
}