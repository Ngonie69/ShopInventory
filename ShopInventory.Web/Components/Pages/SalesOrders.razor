@page "/sales-orders"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ISalesOrderService SalesOrderService
@inject IBusinessPartnerService BusinessPartnerService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Sales Orders - Shop Inventory</PageTitle>

<div class="page-shell">
    <div class="container-fluid">
        <div class="page-hero">
            <div>
                <h2 class="page-title mb-1"><i class="bi bi-cart-check me-2 text-primary"></i>Sales Orders</h2>
                <p class="page-subtitle">Track order status and fulfillment</p>
            </div>
            <button class="btn btn-page-primary" @onclick="() => showCreateModal = true">
                <i class="bi bi-plus-circle me-2"></i>New Sales Order
            </button>
        </div>

        <!-- Filters -->
        <div class="card page-card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-funnel me-2"></i>Filter</h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label">Order Number</label>
                        <input type="text" class="form-control" @bind="orderNumberFilter" placeholder="e.g., SO-001" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Customer</label>
                        <input type="text" class="form-control" @bind="customerFilter" placeholder="Customer code" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select class="form-select" @bind="statusFilter">
                            <option value="">All Statuses</option>
                            @foreach (SalesOrderStatus status in Enum.GetValues(typeof(SalesOrderStatus)))
                            {
                                <option value="@((int)status)">@status</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-control" @bind="fromDate" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-control" @bind="toDate" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="d-flex gap-2">
                            <button class="btn btn-page-primary" @onclick="ApplyFilter">
                                <i class="bi bi-search me-1"></i>Search
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="ClearFilter">
                                <i class="bi bi-x-circle me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mt-3">
                    <div class="col-md-2">
                        <label class="form-label">Records per page</label>
                        <select class="form-select" @bind="pageSize" @bind:after="OnPageSizeChanged">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading sales orders...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
        </div>
    }
    else if (orders?.Any() == true)
    {
        <div class="card page-card">
            <div class="card-body p-4">
                <div class="table-responsive">
                    <table class="table table-hover align-middle page-table">
                        <thead class="table-light">
                            <tr>
                                <th>Doc Entry</th>
                                <th>Doc #</th>
                                <th>Customer</th>
                                <th>Order Date</th>
                                <th>Delivery Date</th>
                                <th>Status</th>
                                <th>Currency</th>
                                <th class="text-end">Total</th>
                                <th>Synced</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in orders)
                            {
                                <tr>
                                    <td>@order.SAPDocEntry</td>
                                    <td><strong>@order.SAPDocNum</strong></td>
                                    <td>
                                        <span class="badge bg-secondary">@order.CardCode</span>
                                        <small class="d-block text-muted">@order.CardName</small>
                                    </td>
                                    <td>@order.OrderDate.ToString("dd MMM yyyy")</td>
                                    <td>@(order.DeliveryDate?.ToString("dd MMM yyyy") ?? "-")</td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(order.Status)">@order.StatusName</span>
                                    </td>
                                    <td>@order.Currency</td>
                                    <td class="text-end"><strong>@order.DocTotal.ToString("N2")</strong></td>
                                    <td>
                                        @if (order.IsSynced)
                                        {
                                            <i class="bi bi-check-circle text-success" title="Synced to SAP"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-clock text-warning" title="Pending sync"></i>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" @onclick="() => ViewOrder(order)"
                                                title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            @* Only show action buttons for local orders (not synced from SAP) *@
                                                    @if (!order.IsSynced)
                                            {
                                                @if (order.Status == SalesOrderStatus.Pending)
                                                {
                                                    <button class="btn btn-outline-success" @onclick="() => ApproveOrder(order.Id)"
                                                        title="Approve">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>
                                                }
                                                @if (order.Status == SalesOrderStatus.Approved)
                                                {
                                                    <button class="btn btn-outline-info" @onclick="() => ConvertToInvoice(order.Id)"
                                                        title="Convert to Invoice">
                                                        <i class="bi bi-receipt"></i>
                                                    </button>
                                                }
                                                @if (order.Status == SalesOrderStatus.Draft || order.Status ==
                                                                                    SalesOrderStatus.Cancelled)
                                                {
                                                    <button class="btn btn-outline-danger" @onclick="() => DeleteOrder(order.Id)"
                                                        title="Delete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                }
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <div class="d-flex flex-column align-items-center mt-4">
                        <MudPagination Color="Color.Primary" Count="totalPages" Selected="currentPage"
                            SelectedChanged="OnPageChanged" ShowFirstButton="true" ShowLastButton="true" />
                        <div class="text-muted small mt-2">
                            Page @currentPage of @totalPages (@totalCount total records)
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>No sales orders found.
        </div>
    }
    </div>
</div>

<!-- View Order Modal -->
@if (selectedOrder != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-cart-check me-2"></i>Sales Order: @selectedOrder.OrderNumber
                    </h5>
                    <button type="button" class="btn-close" @onclick="() => selectedOrder = null"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Customer:</strong> @selectedOrder.CardCode - @selectedOrder.CardName</p>
                            <p><strong>Order Date:</strong> @selectedOrder.OrderDate.ToString("dd MMM yyyy")</p>
                            <p><strong>Delivery Date:</strong> @(selectedOrder.DeliveryDate?.ToString("dd MMM yyyy") ?? "Not                          set")</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> <span
                                    class="badge @GetStatusBadgeClass(selectedOrder.Status)">@selectedOrder.StatusName</span>
                            </p>
                            <p><strong>Currency:</strong> @selectedOrder.Currency</p>
                            <p><strong>Created By:</strong> @selectedOrder.CreatedByUserName</p>
                        </div>
                    </div>

                    @if (selectedOrder.Lines?.Any() == true)
                    {
                        <h6>Order Lines</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Description</th>
                                    <th class="text-end">Qty</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var line in selectedOrder.Lines)
                                {
                                    <tr>
                                        <td>@line.ItemCode</td>
                                        <td>@line.ItemDescription</td>
                                        <td class="text-end">@line.Quantity</td>
                                        <td class="text-end">@line.UnitPrice.ToString("N2")</td>
                                        <td class="text-end">@line.LineTotal.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-end">@selectedOrder.SubTotal.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Tax:</strong></td>
                                    <td class="text-end">@selectedOrder.TaxAmount.ToString("N2")</td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                    <td class="text-end"><strong>@selectedOrder.DocTotal.ToString("N2")</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => selectedOrder = null">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Create Order Modal -->
@if (showCreateModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>New Sales Order</h5>
                    <button type="button" class="btn-close" @onclick="() => showCreateModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Customer Code *</label>
                            <input type="text" class="form-control" @bind="newOrder.CardCode" placeholder="e.g., C001" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-control" @bind="newOrder.CardName" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Delivery Date</label>
                            <input type="date" class="form-control" @bind="newOrder.DeliveryDate" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Currency</label>
                            <select class="form-select" @bind="newOrder.Currency">
                                <option value="USD">USD</option>
                                <option value="ZIG">ZIG</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Comments</label>
                            <textarea class="form-control" @bind="newOrder.Comments" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCreateModal = false">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateOrder" disabled="@isCreating">
                        @if (isCreating)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Create Order
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<SalesOrderDto>? orders;
    private SalesOrderDto? selectedOrder;
    private bool isLoading = true;
    private bool isCreating = false;
    private bool showCreateModal = false;
    private string? errorMessage;

    // Filters
    private string? orderNumberFilter;
    private string? customerFilter;
    private string? statusFilter;
    private DateTime? fromDate;
    private DateTime? toDate;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalPages = 1;
    private int totalCount = 0;

    // New order
    private CreateSalesOrderRequest newOrder = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            SalesOrderStatus? status = null;
            if (!string.IsNullOrEmpty(statusFilter) && int.TryParse(statusFilter, out var statusInt))
            {
                status = (SalesOrderStatus)statusInt;
            }

            var response = await SalesOrderService.GetSalesOrdersAsync(currentPage, pageSize, status, customerFilter, fromDate,
            toDate);
            if (response != null)
            {
                orders = response.Orders;
                totalCount = response.TotalCount;
                totalPages = response.TotalPages;
            }
            else
            {
                errorMessage = "Failed to load sales orders.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ApplyFilter() => await LoadOrders();

    private async Task ClearFilter()
    {
        orderNumberFilter = null;
        customerFilter = null;
        statusFilter = null;
        fromDate = null;
        toDate = null;
        currentPage = 1;
        await LoadOrders();
    }

    private async Task OnPageChanged(int page)
    {
        await GoToPage(page);
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadOrders();
        }
    }

    private void ViewOrder(SalesOrderDto order)
    {
        selectedOrder = order;
    }

    private async Task ApproveOrder(int id)
    {
        var result = await SalesOrderService.ApproveAsync(id);
        if (result != null)
        {
            await LoadOrders();
        }
    }

    private async Task ConvertToInvoice(int id)
    {
        var result = await SalesOrderService.ConvertToInvoiceAsync(id);
        if (result != null)
        {
            NavigationManager.NavigateTo($"/invoices");
        }
    }

    private async Task DeleteOrder(int id)
    {
        var success = await SalesOrderService.DeleteSalesOrderAsync(id);
        if (success)
        {
            await LoadOrders();
        }
    }

    private async Task CreateOrder()
    {
        if (string.IsNullOrEmpty(newOrder.CardCode))
        {
            return;
        }

        isCreating = true;
        try
        {
            var result = await SalesOrderService.CreateSalesOrderAsync(newOrder);
            if (result != null)
            {
                showCreateModal = false;
                newOrder = new();
                await LoadOrders();
            }
        }
        finally
        {
            isCreating = false;
        }
    }

    private string GetStatusBadgeClass(SalesOrderStatus status) => status switch
    {
        SalesOrderStatus.Draft => "bg-secondary",
        SalesOrderStatus.Pending => "bg-warning text-dark",
        SalesOrderStatus.Approved => "bg-success",
        SalesOrderStatus.PartiallyFulfilled => "bg-info",
        SalesOrderStatus.Fulfilled => "bg-primary",
        SalesOrderStatus.Invoiced => "bg-success",
        SalesOrderStatus.Cancelled => "bg-danger",
        SalesOrderStatus.OnHold => "bg-dark",
        _ => "bg-secondary"
    };

    private async Task OnPageSizeChanged()
    {
        currentPage = 1;
        await LoadOrders();
    }
}
