@page "/"
@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IInvoiceService InvoiceService
@inject IPaymentService PaymentService
@inject IInventoryTransferService TransferService
@rendermode InteractiveServer

<PageTitle>Dashboard - Shop Inventory</PageTitle>

<div class="container-fluid fade-in staff-dashboard">
    <div class="dashboard-hero">
        <div class="page-header staff-dashboard-header">
            <div class="dashboard-title">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor"
                         viewBox="0 0 16 16">
                        <path
                        d="M8 4a.5.5 0 0 1 .5.5V6a.5.5 0 0 1-1 0V4.5A.5.5 0 0 1 8 4zM3.732 5.732a.5.5 0 0 1 .707 0l.915.914a.5.5 0 1 1-.708.708l-.914-.915a.5.5 0 0 1 0-.707zM2 10a.5.5 0 0 1 .5-.5h1.586a.5.5 0 0 1 0 1H2.5A.5.5 0 0 1 2 10zm9.5 0a.5.5 0 0 1 .5-.5h1.5a.5.5 0 0 1 0 1H12a.5.5 0 0 1-.5-.5zm.754-4.246a.389.389 0 0 0-.527-.02L7.547 9.31a.91.91 0 1 0 1.302 1.258l3.434-4.297a.389.389 0 0 0-.029-.518z" />
                        <path fill-rule="evenodd"
                              d="M0 10a8 8 0 1 1 15.547 2.661c-.442 1.253-1.845 1.602-2.932 1.25C11.309 13.488 9.475 13 8 13c-1.474 0-3.31.488-4.615.911-1.087.352-2.49.003-2.932-1.25A7.988 7.988 0 0 1 0 10zm8-7a7 7 0 0 0-6.603 9.329c.203.575.923.876 1.68.63C4.397 12.533 6.358 12 8 12s3.604.532 4.923.96c.757.245 1.477-.056 1.68-.631A7 7 0 0 0 8 3z" />
                    </svg>
                    Dashboard
                </h2>
                <span class="text-muted">Overview of your business</span>
            </div>
            <div class="dashboard-meta">
                <span class="meta-pill">
                    <span class="meta-dot"></span>
                    Live operations
                </span>
                <span class="meta-subtitle">Updated on refresh</span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4 g-4 dashboard-stats">
        <div class="col-md-4">
            <div class="card stat-card staff-stat-card bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="stat-label mb-2">Total Invoices</p>
                            <h2 class="stat-value">@todayInvoiceCount</h2>
                        </div>
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor"
                                 viewBox="0 0 16 16">
                                <path
                                d="M1.92.506a.5.5 0 0 1 .434.14L3 1.293l.646-.647a.5.5 0 0 1 .708 0L5 1.293l.646-.647a.5.5 0 0 1 .708 0L7 1.293l.646-.647a.5.5 0 0 1 .708 0L9 1.293l.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .801.13l.5 1A.5.5 0 0 1 15 2v12a.5.5 0 0 1-.053.224l-.5 1a.5.5 0 0 1-.8.13L13 14.707l-.646.647a.5.5 0 0 1-.708 0L11 14.707l-.646.647a.5.5 0 0 1-.708 0L9 14.707l-.646.647a.5.5 0 0 1-.708 0L7 14.707l-.646.647a.5.5 0 0 1-.708 0L5 14.707l-.646.647a.5.5 0 0 1-.708 0L3 14.707l-.646.647a.5.5 0 0 1-.801-.13l-.5-1A.5.5 0 0 1 1 14V2a.5.5 0 0 1 .053-.224l.5-1a.5.5 0 0 1 .367-.27z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="invoices" class="stat-link d-flex align-items-center">
                        View all invoices
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             viewBox="0 0 16 16" class="ms-2">
                            <path fill-rule="evenodd"
                                  d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card stat-card staff-stat-card bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="stat-label mb-2">Total Payments</p>
                            <h2 class="stat-value">@todayPaymentCount</h2>
                        </div>
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor"
                                 viewBox="0 0 16 16">
                                <path d="M8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" />
                                <path
                                d="M0 4a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V4zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V6a2 2 0 0 1-2-2H3z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="payments" class="stat-link d-flex align-items-center">
                        View all payments
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             viewBox="0 0 16 16" class="ms-2">
                            <path fill-rule="evenodd"
                                  d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card stat-card staff-stat-card bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="stat-label mb-2">Inventory Transfers</p>
                            <h2 class="stat-value">@transferCount</h2>
                        </div>
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor"
                                 viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                      d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <a href="inventory-transfers" class="stat-link d-flex align-items-center">
                        View all transfers
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             viewBox="0 0 16 16" class="ms-2">
                            <path fill-rule="evenodd"
                                  d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Data -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card h-100 dashboard-panel">
                <div class="card-header d-flex align-items-center justify-content-between dashboard-panel-header">
                    <h5 class="mb-0 d-flex align-items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                             viewBox="0 0 16 16" class="panel-icon">
                            <path
                            d="M1.92.506a.5.5 0 0 1 .434.14L3 1.293l.646-.647a.5.5 0 0 1 .708 0L5 1.293l.646-.647a.5.5 0 0 1 .708 0L7 1.293l.646-.647a.5.5 0 0 1 .708 0L9 1.293l.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .801.13l.5 1A.5.5 0 0 1 15 2v12a.5.5 0 0 1-.053.224l-.5 1a.5.5 0 0 1-.8.13L13 14.707l-.646.647a.5.5 0 0 1-.708 0L11 14.707l-.646.647a.5.5 0 0 1-.708 0L9 14.707l-.646.647a.5.5 0 0 1-.708 0L7 14.707l-.646.647a.5.5 0 0 1-.708 0L5 14.707l-.646.647a.5.5 0 0 1-.708 0L3 14.707l-.646.647a.5.5 0 0 1-.801-.13l-.5-1A.5.5 0 0 1 1 14V2a.5.5 0 0 1 .053-.224l.5-1a.5.5 0 0 1 .367-.27z" />
                        </svg>
                        Recent Invoices
                    </h5>
                    <a href="invoices" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body p-0">
                    @if (isLoadingInvoices)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border" role="status" style="width: 2.5rem; height: 2.5rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2 mb-0">Loading invoices...</p>
                        </div>
                    }
                    else if (recentInvoices?.Any() == true)
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle dashboard-table">
                                <thead>
                                    <tr>
                                        <th>Doc #</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var invoice in recentInvoices.Take(5))
                                    {
                                        <tr>
                                            <td><span class="badge bg-primary">@invoice.DocNum</span></td>
                                            <td>@invoice.CardName</td>
                                            <td>@(DateTime.TryParse(invoice.DocDate, out var invoiceDate) ?
                                                                                                                                                                                        invoiceDate.ToString("dd MMM yyyy") : invoice.DocDate)</td>
                                                <td class="text-end fw-semibold">@invoice.DocCurrency
                                                    @invoice.DocTotal.ToString("N2")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                    else
                            {
                                <div class="text-center py-5 dashboard-empty">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="var(--text-muted)"
                                         viewBox="0 0 16 16" class="mb-3" style="opacity: 0.5;">
                                        <path
                                        d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                                        <path
                                        d="M4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8zm0 2.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5z" />
                                    </svg>
                                    <p class="text-muted mb-0">No recent invoices</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card h-100 dashboard-panel">
                        <div class="card-header d-flex align-items-center justify-content-between dashboard-panel-header">
                            <h5 class="mb-0 d-flex align-items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                     viewBox="0 0 16 16" class="panel-icon panel-icon-emerald">
                                    <path d="M8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" />
                                    <path
                                    d="M0 4a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V4zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V6a2 2 0 0 1-2-2H3z" />
                                </svg>
                                Recent Payments
                            </h5>
                            <a href="payments" class="btn btn-sm btn-outline-success">View All</a>
                        </div>
                        <div class="card-body p-0">
                            @if (isLoadingPayments)
                            {
                                <div class="text-center py-5">
                                    <div class="spinner-border text-success" role="status" style="width: 2.5rem; height: 2.5rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2 mb-0">Loading payments...</p>
                                </div>
                            }
                            else if (recentPayments?.Any() == true)
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 align-middle dashboard-table">
                                        <thead>
                                            <tr>
                                                <th>Doc #</th>
                                                <th>Customer</th>
                                                <th>Date</th>
                                                <th class="text-end">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var payment in recentPayments.Take(5))
                                            {
                                                <tr>
                                                    <td><span class="badge bg-success">@payment.DocNum</span></td>
                                                    <td>@payment.CardName</td>
                                                    <td>@(DateTime.TryParse(payment.DocDate, out var paymentDate) ?
                                                                                                                                                                                                        paymentDate.ToString("dd MMM yyyy") : payment.DocDate)</td>
                                                        <td class="text-end fw-semibold">@payment.DocCurrency
                                                            @payment.DocTotal.ToString("N2")</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                    else
                                    {
                                        <div class="text-center py-5 dashboard-empty">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="var(--text-muted)"
                                                 viewBox="0 0 16 16" class="mb-3" style="opacity: 0.5;">
                                                <path d="M8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" />
                                                <path
                                                d="M0 4a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V4zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V6a2 2 0 0 1-2-2H3z" />
                                            </svg>
                                            <p class="text-muted mb-0">No recent payments</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card dashboard-panel dashboard-actions">
                                <div class="card-header dashboard-panel-header">
                                    <h5 class="mb-0 d-flex align-items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                             viewBox="0 0 16 16" class="panel-icon panel-icon-amber">
                                            <path
                                            d="M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641l2.5-8.5z" />
                                        </svg>
                                        Quick Actions
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 dashboard-action-grid">
                                        <div class="col-md-3 col-sm-6">
                                            <a href="invoices/create" class="action-tile action-primary">
                                                <div class="tile-icon">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                                         viewBox="0 0 16 16">
                                                        <path
                                                        d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                                                    </svg>
                                                </div>
                                                <span>Create Invoice</span>
                                            </a>
                                        </div>
                                        <div class="col-md-3 col-sm-6">
                                            <a href="invoices" class="action-tile action-sky">
                                                <div class="tile-icon">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                                         viewBox="0 0 16 16">
                                                        <path
                                                        d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                                                    </svg>
                                                </div>
                                                <span>Search Invoices</span>
                                            </a>
                                        </div>
                                        <div class="col-md-3 col-sm-6">
                                            <a href="products" class="action-tile action-emerald">
                                                <div class="tile-icon">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                                         viewBox="0 0 16 16">
                                                        <path
                                                        d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z" />
                                                    </svg>
                                                </div>
                                                <span>View Products</span>
                                            </a>
                                        </div>
                                        <div class="col-md-3 col-sm-6">
                                            <a href="prices" class="action-tile action-amber">
                                                <div class="tile-icon">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                                         viewBox="0 0 16 16">
                                                        <path
                                                        d="M3 2v4.586l7 7L14.586 9l-7-7H3zM2 2a1 1 0 0 1 1-1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 2 6.586V2z" />
                                                        <path
                                                        d="M5.5 5a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm0 1a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z" />
                                                    </svg>
                                                </div>
                                                <span>View Prices</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

@code {
    private int todayInvoiceCount = 0;
    private int todayPaymentCount = 0;
    private int transferCount = 0;
    private List<InvoiceDto>? recentInvoices;
    private List<IncomingPaymentDto>? recentPayments;
    private bool isLoadingInvoices = true;
    private bool isLoadingPayments = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        // Load invoices
        try
        {
            var invoiceResponse = await InvoiceService.GetInvoicesAsync(1, 10);
            if (invoiceResponse?.Invoices != null)
            {
                recentInvoices = invoiceResponse.Invoices;
                todayInvoiceCount = invoiceResponse.Count;
            }
        }
        catch
        {
            // Handle error silently
        }
        finally
        {
            isLoadingInvoices = false;
        }

        // Load payments
        try
        {
            var paymentResponse = await PaymentService.GetPaymentsAsync(1, 10);
            if (paymentResponse?.Payments != null)
            {
                recentPayments = paymentResponse.Payments;
                todayPaymentCount = paymentResponse.Count;
            }
        }
        catch
        {
            // Handle error silently
        }
        finally
        {
            isLoadingPayments = false;
        }
    }
}