@page "/documents/{EntityType}/{EntityId:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Document Manager - Shop Inventory</PageTitle>

<div class="container-fluid fade-in">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-file-earmark-pdf me-2" style="color: var(--primary-color);"></i>
                    Document Manager
                </h2>
                <span class="text-muted">@EntityType #@EntityId</span>
            </div>
            <button class="btn btn-secondary" @onclick="GoBack">
                <i class="bi bi-arrow-left me-2"></i>Back
            </button>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Actions -->
        <div class="col-lg-8">
            <!-- Generate Document -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-file-pdf me-2"></i>Generate Document</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Select Template</label>
                            <select class="form-select" @bind="selectedTemplateId">
                                <option value="0">Use default template</option>
                                @if (templates != null)
                                {
                                    @foreach (var template in templates)
                                    {
                                        <option value="@template.Id">@template.Name @(template.IsDefault ? "(Default)" : "")
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" @onclick="GenerateDocument" disabled="@isGenerating">
                                    @if (isGenerating)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-file-earmark-pdf me-2"></i>Generate PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    @if (generateError != null)
                    {
                        <div class="alert alert-danger mt-3">@generateError</div>
                    }
                    @if (generateSuccess != null)
                    {
                        <div class="alert alert-success mt-3">@generateSuccess</div>
                    }
                </div>
            </div>

            <!-- Email Document -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-envelope me-2"></i>Email Document</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Recipient Email *</label>
                            <input type="email" class="form-control" @bind="recipientEmail"
                                placeholder="customer@example.com" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Recipient Name</label>
                            <input type="text" class="form-control" @bind="recipientName" placeholder="Customer Name" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" @bind="emailSubject" placeholder="Your Invoice" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" @bind="emailBody" rows="4"
                                placeholder="Dear customer..."></textarea>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="includeAttachments"
                                    id="includeAttachments">
                                <label class="form-check-label" for="includeAttachments">
                                    Include all attachments
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-success" @onclick="EmailDocument"
                                disabled="@isEmailing || string.IsNullOrEmpty(recipientEmail)">
                                @if (isEmailing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-send me-2"></i>Send Email
                            </button>
                        </div>
                    </div>
                    @if (emailError != null)
                    {
                        <div class="alert alert-danger mt-3">@emailError</div>
                    }
                    @if (emailSuccess != null)
                    {
                        <div class="alert alert-success mt-3">@emailSuccess</div>
                    }
                </div>
            </div>

            <!-- Digital Signature -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-pen me-2"></i>Digital Signature</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Signer Name *</label>
                            <input type="text" class="form-control" @bind="signerName" placeholder="John Doe" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Signer Email</label>
                            <input type="email" class="form-control" @bind="signerEmail"
                                placeholder="signer@example.com" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Role</label>
                            <select class="form-select" @bind="signerRole">
                                <option value="Customer">Customer</option>
                                <option value="Supplier">Supplier</option>
                                <option value="Manager">Manager</option>
                                <option value="Accountant">Accountant</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Signature Pad</label>
                            <div class="border rounded p-2 bg-white" style="height: 200px;">
                                <canvas id="signaturePad" width="700" height="180"
                                    style="border: 1px dashed #ccc; cursor: crosshair;"></canvas>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearSignature">
                                    <i class="bi bi-eraser"></i> Clear
                                </button>
                                <button class="btn btn-sm btn-primary ms-2" @onclick="SaveSignature"
                                    disabled="@isSavingSignature">
                                    @if (isSavingSignature)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-check2"></i> Save Signature
                                </button>
                            </div>
                        </div>
                    </div>
                    @if (signatureError != null)
                    {
                        <div class="alert alert-danger mt-3">@signatureError</div>
                    }
                    @if (signatureSuccess != null)
                    {
                        <div class="alert alert-success mt-3">@signatureSuccess</div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column: Attachments & History -->
        <div class="col-lg-4">
            <!-- Attachments -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Attachments</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Upload File</label>
                        <InputFile OnChange="HandleFileSelected" class="form-control" />
                        @if (isUploading)
                        {
                            <div class="mt-2">
                                <div class="spinner-border spinner-border-sm me-2"></div>
                                Uploading...
                            </div>
                        }
                    </div>
                    @if (attachments?.Any() == true)
                    {
                        <div class="list-group">
                            @foreach (var attachment in attachments)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">@attachment.FileName</h6>
                                            <small class="text-muted">@attachment.FileSizeFormatted</small>
                                            @if (!string.IsNullOrEmpty(attachment.Description))
                                            {
                                                <p class="mb-1"><small>@attachment.Description</small></p>
                                            }
                                        </div>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button class="btn btn-outline-primary"
                                                @onclick="() => DownloadAttachment(attachment.Id)">
                                                <i class="bi bi-download"></i>
                                            </button>
                                            <button class="btn btn-outline-danger"
                                                @onclick="() => DeleteAttachment(attachment.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No attachments</p>
                    }
                </div>
            </div>

            <!-- Document History -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>History</h5>
                </div>
                <div class="card-body">
                    @if (history?.Any() == true)
                    {
                        <div class="timeline">
                            @foreach (var item in history)
                            {
                                <div class="timeline-item mb-3">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <i class="bi @GetHistoryIcon(item.Action) text-primary"></i>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-0">@item.Action</h6>
                                            <small class="text-muted">@item.GeneratedAt.ToLocalTime().ToString("g")</small>
                                            @if (!string.IsNullOrEmpty(item.RecipientEmail))
                                            {
                                                <p class="mb-0"><small>To: @item.RecipientEmail</small></p>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No history</p>
                    }
                </div>
            </div>

            <!-- Signatures -->
            @if (signatures?.Any() == true)
            {
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pen me-2"></i>Signatures</h5>
                    </div>
                    <div class="card-body">
                        @foreach (var sig in signatures)
                        {
                            <div class="mb-3 p-2 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-0">@sig.SignerName</h6>
                                        <small class="text-muted">@sig.SignerRole</small>
                                        <p class="mb-0"><small>@sig.SignedAt.ToLocalTime().ToString("g")</small></p>
                                    </div>
                                    @if (sig.IsVerified)
                                    {
                                        <span class="badge bg-success">Verified</span>
                                    }
                                </div>
                                <img src="@sig.SignatureData" alt="Signature" class="img-fluid mt-2"
                                    style="max-height: 80px;" />
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public string EntityType { get; set; } = "";
    [Parameter] public int EntityId { get; set; }

    private List<DocumentTemplateDto>? templates;
    private List<DocumentAttachmentDto>? attachments;
    private List<DocumentHistoryDto>? history;
    private List<DocumentSignatureDto>? signatures;

    private int selectedTemplateId;
    private bool isGenerating, isEmailing, isUploading, isSavingSignature;
    private string? generateError, generateSuccess, emailError, emailSuccess, signatureError, signatureSuccess;

    // Email fields
    private string recipientEmail = "";
    private string? recipientName;
    private string? emailSubject;
    private string? emailBody;
    private bool includeAttachments = true;

    // Signature fields
    private string signerName = "";
    private string? signerEmail;
    private string signerRole = "Customer";

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(
        LoadTemplates(),
        LoadAttachments(),
        LoadHistory(),
        LoadSignatures()
        );
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initializeSignaturePad", "signaturePad");
        }
    }

    private async Task LoadTemplates()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<DocumentTemplateListResponseDto>(
            $"/api/document/templates?documentType={EntityType}&activeOnly=true");
            templates = response?.Templates;
        }
        catch { }
    }

    private async Task LoadAttachments()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<DocumentAttachmentListResponseDto>(
            $"/api/document/attachments?entityType={EntityType}&entityId={EntityId}");
            attachments = response?.Attachments;
        }
        catch { }
    }

    private async Task LoadHistory()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<DocumentHistoryListResponseDto>(
            $"/api/document/history?documentType={EntityType}&entityId={EntityId}");
            history = response?.History;
        }
        catch { }
    }

    private async Task LoadSignatures()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<DocumentSignatureListResponseDto>(
            $"/api/document/signatures?documentType={EntityType}&documentId={EntityId}");
            signatures = response?.Signatures;
        }
        catch { }
    }

    private async Task GenerateDocument()
    {
        isGenerating = true;
        generateError = null;
        generateSuccess = null;

        try
        {
            var request = new GenerateDocumentRequest
            {
                DocumentType = EntityType,
                EntityId = EntityId,
                TemplateId = selectedTemplateId > 0 ? selectedTemplateId : null,
                SaveToHistory = true
            };

            var response = await Http.PostAsJsonAsync("/api/document/generate/download", request);
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"{EntityType}_{EntityId}.pdf";
                await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(content));
                generateSuccess = "Document generated and downloaded successfully!";
                await LoadHistory();
            }
            else
            {
                generateError = "Failed to generate document.";
            }
        }
        catch (Exception ex)
        {
            generateError = $"Error: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }

    private async Task EmailDocument()
    {
        isEmailing = true;
        emailError = null;
        emailSuccess = null;

        try
        {
            var request = new EmailDocumentRequest
            {
                DocumentType = EntityType,
                EntityId = EntityId,
                TemplateId = selectedTemplateId > 0 ? selectedTemplateId : null,
                RecipientEmail = recipientEmail,
                RecipientName = recipientName,
                Subject = emailSubject,
                MessageBody = emailBody,
                IncludeAttachments = includeAttachments
            };

            var response = await Http.PostAsJsonAsync("/api/document/email", request);
            if (response.IsSuccessStatusCode)
            {
                emailSuccess = $"Document sent successfully to {recipientEmail}!";
                await LoadHistory();
            }
            else
            {
                emailError = "Failed to send email.";
            }
        }
        catch (Exception ex)
        {
            emailError = $"Error: {ex.Message}";
        }
        finally
        {
            isEmailing = false;
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        isUploading = true;
        try
        {
            var file = e.File;
            using var content = new MultipartFormDataContent();

            var fileContent = new StreamContent(file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024));
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);

            content.Add(new StringContent(EntityType), "entityType");
            content.Add(new StringContent(EntityId.ToString()), "entityId");
            content.Add(new StringContent("true"), "includeInEmail");
            content.Add(fileContent, "file", file.Name);

            var response = await Http.PostAsync("/api/document/attachments", content);
            if (response.IsSuccessStatusCode)
            {
                await LoadAttachments();
                await JS.InvokeVoidAsync("alert", "File uploaded successfully!");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error uploading file: {ex.Message}");
        }
        finally
        {
            isUploading = false;
        }
    }

    private async Task DownloadAttachment(int attachmentId)
    {
        Navigation.NavigateTo($"/api/document/attachments/{attachmentId}/download", true);
    }

    private async Task DeleteAttachment(int attachmentId)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Delete this attachment?"))
        {
            var response = await Http.DeleteAsync($"/api/document/attachments/{attachmentId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadAttachments();
            }
        }
    }

    private async Task ClearSignature()
    {
        await JS.InvokeVoidAsync("clearSignaturePad");
    }

    private async Task SaveSignature()
    {
        if (string.IsNullOrEmpty(signerName))
        {
            signatureError = "Please enter signer name.";
            return;
        }

        isSavingSignature = true;
        signatureError = null;
        signatureSuccess = null;

        try
        {
            var signatureData = await JS.InvokeAsync<string>("getSignatureData");
            if (string.IsNullOrEmpty(signatureData) || signatureData == "data:,")
            {
                signatureError = "Please provide a signature.";
                return;
            }

            var request = new CreateSignatureRequest
            {
                DocumentType = EntityType,
                DocumentId = EntityId,
                SignerName = signerName,
                SignerEmail = signerEmail,
                SignerRole = signerRole,
                SignatureData = signatureData
            };

            var response = await Http.PostAsJsonAsync("/api/document/signatures", request);
            if (response.IsSuccessStatusCode)
            {
                signatureSuccess = "Signature saved successfully!";
                await ClearSignature();
                await LoadSignatures();
            }
            else
            {
                signatureError = "Failed to save signature.";
            }
        }
        catch (Exception ex)
        {
            signatureError = $"Error: {ex.Message}";
        }
        finally
        {
            isSavingSignature = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo($"/{EntityType.ToLower()}s");
    }

    private string GetHistoryIcon(string action) => action switch
    {
        "Generated" => "bi-file-earmark-pdf",
        "Emailed" => "bi-envelope",
        "Downloaded" => "bi-download",
        "Printed" => "bi-printer",
        _ => "bi-circle"
    };

    // DTOs (simplified versions - should match server DTOs)
    public class DocumentTemplateDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = ""; public bool
        IsDefault
        { get; set; }
    }
    public class DocumentTemplateListResponseDto { public List<DocumentTemplateDto> Templates { get; set; } = new(); }
    public class DocumentAttachmentDto
    {
        public int Id { get; set; }
        public string FileName { get; set; } = ""; public
        string FileSizeFormatted
        { get; set; } = ""; public string? Description { get; set; }
    }
    public class DocumentAttachmentListResponseDto { public List<DocumentAttachmentDto> Attachments { get; set; } = new(); }
    public class DocumentHistoryDto
    {
        public string Action { get; set; } = ""; public DateTime GeneratedAt { get; set; }
        public string? RecipientEmail { get; set; }
    }
    public class DocumentHistoryListResponseDto { public List<DocumentHistoryDto> History { get; set; } = new(); }
    public class DocumentSignatureDto
    {
        public string SignerName { get; set; } = ""; public string SignerRole { get; set; }
        = ""; public string SignatureData { get; set; } = ""; public DateTime SignedAt { get; set; }
        public bool IsVerified
        {
            get; set;
        }
    }
    public class DocumentSignatureListResponseDto { public List<DocumentSignatureDto> Signatures { get; set; } = new(); }
    public class GenerateDocumentRequest
    {
        public string DocumentType { get; set; } = ""; public int EntityId { get; set; }
        public int? TemplateId { get; set; }
        public bool SaveToHistory { get; set; }
    }
    public class EmailDocumentRequest
    {
        public string DocumentType { get; set; } = ""; public int EntityId { get; set; }
        public int? TemplateId { get; set; }
        public string RecipientEmail { get; set; } = ""; public string? RecipientName
        {
            get; set;
        }
        public string? Subject { get; set; }
        public string? MessageBody { get; set; }
        public bool IncludeAttachments
        { get; set; }
    }
    public class CreateSignatureRequest
    {
        public string DocumentType { get; set; } = ""; public int DocumentId { get; set; }
        public string SignerName { get; set; } = ""; public string? SignerEmail { get; set; }
        public string SignerRole
        {
            get;
            set;
        } = ""; public string SignatureData { get; set; } = "";
    }
}