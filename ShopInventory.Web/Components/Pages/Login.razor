@page "/login"
@using Microsoft.AspNetCore.Authorization
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject CustomAuthStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@inject ILogger<Login> Logger
@attribute [AllowAnonymous]
@rendermode InteractiveServer
@layout EmptyLayout

<PageTitle>Login - Shop Inventory</PageTitle>

<div class="login-page auth-page">
    <div class="auth-shell">
        <section class="auth-visual">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>
            <div class="orb orb-3"></div>
            <div class="orb orb-4"></div>
            <div class="visual-content">
                <div class="visual-brand">
                    <div class="brand-logo">
                        <img src="images/kefalos-logo.jpg" alt="Kefalos" />
                    </div>
                    <div class="brand-text">
                        <span class="brand-name">Kefalos Network</span>
                        <span class="brand-tag">Inventory Platform</span>
                    </div>
                </div>
                <div class="visual-card">
                    <p class="visual-eyebrow">Staff Workspace</p>
                    <h2>Inventory that feels effortless.</h2>
                    <p class="visual-copy">
                        Track stock, approve orders, and run reports in one place.
                    </p>
                    <div class="visual-footer">
                        <span>Customer access?</span>
                        <a class="visual-link" href="/customer-portal/login">Customer portal &rarr;</a>
                    </div>
                </div>
            </div>
        </section>

        <section class="auth-form">
            <div class="login-header">
                <span class="eyebrow">Staff Login</span>
                <h1>Sign in</h1>
                <p class="subtitle">Use your staff credentials to continue.</p>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path
                        d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                    </svg>
                    <span>@errorMessage</span>
                </div>
            }

            <EditForm Model="loginModel" OnValidSubmit="HandleLogin" FormName="LoginForm">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label for="username">Username</label>
                    <div class="input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                             viewBox="0 0 16 16">
                            <path
                            d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10Z" />
                        </svg>
                        <InputText id="username" class="form-input" @bind-Value="loginModel.Username"
                                   placeholder="Enter your username" />
                    </div>
                    <ValidationMessage For="@(() => loginModel.Username)" class="validation-msg" />
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                             viewBox="0 0 16 16">
                            <path
                            d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
                        </svg>
                        <input id="password" type="@(showPassword ? "text" : "password")"
                               class="form-input password-input" @bind="loginModel.Password"
                               placeholder="Enter your password" />
                        <button type="button" class="password-toggle" @onclick="TogglePassword" tabindex="-1">
                            @if (showPassword)
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                     viewBox="0 0 16 16">
                                    <path
                                    d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z" />
                                    <path
                                    d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z" />
                                    <path
                                    d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z" />
                                </svg>
                            }
                            else
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                     viewBox="0 0 16 16">
                                    <path
                                    d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z" />
                                    <path
                                    d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z" />
                                </svg>
                            }
                        </button>
                    </div>
                    <ValidationMessage For="@(() => loginModel.Password)" class="validation-msg" />
                </div>

                <button type="submit" class="submit-btn" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner"></span>
                        <span>Signing in...</span>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z" />
                            <path fill-rule="evenodd"
                                  d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z" />
                        </svg>
                        <span>Sign in</span>
                    }
                </button>
            </EditForm>

            <p class="footer-text">Â© 2026 Shop Inventory System</p>
        </section>
    </div>
</div>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap');

    .login-page.auth-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2.5rem 1.5rem;
        background: linear-gradient(135deg, #0b0b0b 0%, #151515 45%, #242424 100%);
        font-family: "Outfit", "Segoe UI", sans-serif;
        color: #111111;
    }

    .auth-shell {
        width: min(1100px, 100%);
        min-height: 640px;
        background: #ffffff;
        border-radius: 28px;
        overflow: hidden;
        display: grid;
        grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
        box-shadow: 0 40px 90px rgba(0, 0, 0, 0.35);
    }

    .auth-visual {
        position: relative;
        padding: 3rem;
        background:
            radial-gradient(circle at 18% 20%, rgba(255, 255, 255, 0.22), rgba(255, 255, 255, 0) 45%),
            radial-gradient(circle at 85% 18%, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0) 40%),
            radial-gradient(circle at 20% 85%, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0) 50%),
            linear-gradient(145deg, #0b0b0b 0%, #1a1a1a 55%, #111111 100%);
        color: #f5f5f5;
        overflow: hidden;
    }

    .auth-visual::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
        pointer-events: none;
    }

    .orb {
        position: absolute;
        border-radius: 50%;
        opacity: 0.95;
        animation: float 12s ease-in-out infinite;
    }

    .orb-1 {
        width: 170px;
        height: 170px;
        top: -40px;
        left: -20px;
        background: radial-gradient(circle at 30% 30%, #f5f5f5, #9c9c9c);
        animation-delay: 0s;
    }

    .orb-2 {
        width: 120px;
        height: 120px;
        top: 40px;
        right: 60px;
        background: radial-gradient(circle at 30% 30%, #ededed, #7d7d7d);
        animation-delay: 1.5s;
    }

    .orb-3 {
        width: 220px;
        height: 220px;
        bottom: -90px;
        left: 35%;
        background: radial-gradient(circle at 30% 30%, #d6d6d6, #4a4a4a);
        animation-delay: 3s;
    }

    .orb-4 {
        width: 140px;
        height: 140px;
        bottom: 40px;
        right: -30px;
        border: 14px solid rgba(255, 255, 255, 0.35);
        background: transparent;
        animation-delay: 2.2s;
    }

    .visual-content {
        position: relative;
        z-index: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 2rem;
    }

    .visual-brand {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .brand-logo {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }

    .brand-logo img {
        width: 40px;
        height: auto;
    }

    .brand-text {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .brand-name {
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        font-size: 1.05rem;
        font-weight: 600;
        letter-spacing: 0.02em;
    }

    .brand-tag {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.72);
    }

    .visual-card {
        background: rgba(17, 17, 17, 0.62);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 2rem;
        border-radius: 22px;
        box-shadow: 0 22px 50px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(12px);
        animation: fadeUp 0.8s ease-out;
    }

    .visual-eyebrow {
        text-transform: uppercase;
        font-size: 0.72rem;
        letter-spacing: 0.25em;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 0.75rem;
    }

    .visual-card h2 {
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        font-size: 2rem;
        margin: 0 0 0.75rem;
    }

    .visual-copy {
        color: rgba(245, 245, 245, 0.78);
        line-height: 1.6;
        margin: 0;
    }

    .visual-footer {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 1.5rem;
        font-size: 0.95rem;
    }

    .visual-link {
        color: #ffffff;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
    }

    .visual-link:hover {
        color: #d4d4d4;
    }

    .auth-form {
        padding: 3.5rem 3rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 1.5rem;
    }

    .login-header h1 {
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        font-size: 2.2rem;
        margin: 0.5rem 0 0.4rem;
    }

    .eyebrow {
        display: inline-flex;
        align-items: center;
        padding: 0.3rem 0.85rem;
        border-radius: 999px;
        background: #111111;
        color: #ffffff;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }

    .subtitle {
        color: #525252;
        margin: 0;
        font-size: 1rem;
    }

    .error-message {
        background: #f2f2f2;
        border: 1px solid #e0e0e0;
        color: #111111;
        padding: 0.9rem 1rem;
        border-radius: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
    }

    .form-group {
        margin-bottom: 1.2rem;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        color: #1f1f1f;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .input-wrapper svg {
        position: absolute;
        left: 1rem;
        color: #8b8b8b;
        pointer-events: none;
        transition: color 0.2s;
    }

    .form-input {
        width: 100%;
        padding: 0.9rem 1rem 0.9rem 2.9rem;
        border: 1px solid #d6d6d6;
        border-radius: 0.9rem;
        font-size: 0.95rem;
        transition: all 0.2s;
        background: #f4f4f4;
    }

    .form-input.password-input {
        padding-right: 3rem;
    }

    .form-input:focus {
        outline: none;
        border-color: #111111;
        background: #ffffff;
        box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.2);
    }

    .input-wrapper:focus-within svg {
        color: #111111;
    }

    .form-input::placeholder {
        color: #9b9b9b;
    }

    .password-toggle {
        position: absolute;
        right: 0.75rem;
        background: none;
        border: none;
        padding: 0.25rem;
        cursor: pointer;
        color: #8b8b8b;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
    }

    .password-toggle:hover {
        color: #111111;
    }

    .password-toggle svg {
        position: static;
        pointer-events: auto;
    }

    .validation-msg {
        color: #2b2b2b;
        font-size: 0.8rem;
        margin-top: 0.4rem;
        display: block;
    }

    .submit-btn {
        width: 100%;
        padding: 0.95rem 1.5rem;
        background: linear-gradient(90deg, #0f0f0f, #2a2a2a);
        color: #ffffff;
        border: none;
        border-radius: 0.9rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 1.4rem;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.3);
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 18px 34px rgba(0, 0, 0, 0.4);
    }

    .submit-btn:active:not(:disabled) {
        transform: translateY(0);
    }

    .submit-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.35);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .footer-text {
        text-align: center;
        color: #9b9b9b;
        font-size: 0.85rem;
        margin: 0;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @@keyframes float {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-12px);
        }
    }

    @@keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(16px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@media (max-width: 1024px) {
        .auth-shell {
            grid-template-columns: 1fr;
        }

        .auth-visual {
            min-height: 280px;
        }
    }

    @@media (max-width: 640px) {
        .auth-form {
            padding: 2.5rem 1.5rem;
        }

        .auth-visual {
            padding: 2rem;
        }

        .visual-card {
            padding: 1.6rem;
        }

        .visual-card h2 {
            font-size: 1.6rem;
        }
    }
</style>

@code {
    private LoginModel loginModel = new();
    private string? errorMessage;
    private bool isLoading = false;
    private bool showPassword = false;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Clear any stale auth data when user explicitly visits login page
            // This prevents redirect loops caused by cached but invalid tokens
            Logger.LogDebug("Login page first render - clearing any stale auth data");
            try
            {
                await AuthStateProvider.ClearAuthData();
                AuthStateProvider.NotifyUserLogout();
            }
            catch (Exception ex)
            {
                Logger.LogDebug("Error clearing auth data: {Message}", ex.Message);
            }
        }
    }

    private void TogglePassword()
    {
        showPassword = !showPassword;
    }

    private async Task HandleLogin()
    {
        Logger.LogInformation("HandleLogin started for user: {Username}", loginModel.Username);
        isLoading = true;
        errorMessage = null;

        try
        {
            Logger.LogDebug("Calling AuthService.LoginAsync");
            var (success, message, response) = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);
            Logger.LogInformation("LoginAsync returned: Success={Success}, Message={Message}", success, message);

            if (success && response != null)
            {
                Logger.LogInformation("Login successful, notifying auth state provider");
                // Notify the auth state provider about the new authentication
                AuthStateProvider.NotifyUserAuthentication(
                response.User?.Username ?? loginModel.Username,
                response.User?.Role ?? "User");

                Logger.LogDebug("Waiting 100ms for state to propagate");
                await Task.Delay(100);

                // Get return URL if present
                var uri = new Uri(NavigationManager.Uri);
                var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
                var returnUrl = queryParams["returnUrl"];

                // Navigate to dashboard by default (not "/" which has a server redirect to login)
                var targetUrl = !string.IsNullOrEmpty(returnUrl) ? Uri.UnescapeDataString(returnUrl) : "/dashboard";
                Logger.LogInformation("Navigating to: {Url}", targetUrl);
                NavigationManager.NavigateTo(targetUrl);
            }
            else
            {
                Logger.LogWarning("Login failed: {Message}", message);
                errorMessage = message;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Exception during HandleLogin");
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            Logger.LogDebug("HandleLogin completed, isLoading set to false");
        }
    }
}