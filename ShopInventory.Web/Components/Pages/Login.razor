@page "/login"
@using Microsoft.AspNetCore.Authorization
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject CustomAuthStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@inject ILogger<Login> Logger
@attribute [AllowAnonymous]
@rendermode InteractiveServer
@layout EmptyLayout

<PageTitle>Login - Shop Inventory</PageTitle>

<div class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z" />
                    </svg>
                </div>
                <h1>Shop Inventory</h1>
                <p class="subtitle">Sign in to your account</p>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                    </svg>
                    <span>@errorMessage</span>
                </div>
            }

            <EditForm Model="loginModel" OnValidSubmit="HandleLogin" FormName="LoginForm">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label for="username">Username</label>
                    <div class="input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10Z" />
                        </svg>
                        <InputText id="username" class="form-input" @bind-Value="loginModel.Username"
                            placeholder="Enter your username" />
                    </div>
                    <ValidationMessage For="@(() => loginModel.Username)" class="validation-msg" />
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
                        </svg>
                        <input id="password" type="@(showPassword ? "text" : "password")"
                            class="form-input password-input" @bind="loginModel.Password"
                            placeholder="Enter your password" />
                        <button type="button" class="password-toggle" @onclick="TogglePassword" tabindex="-1">
                            @if (showPassword)
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                    viewBox="0 0 16 16">
                                    <path
                                        d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z" />
                                    <path
                                        d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z" />
                                    <path
                                        d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z" />
                                </svg>
                            }
                            else
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                    viewBox="0 0 16 16">
                                    <path
                                        d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z" />
                                    <path
                                        d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z" />
                                </svg>
                            }
                        </button>
                    </div>
                    <ValidationMessage For="@(() => loginModel.Password)" class="validation-msg" />
                </div>

                <button type="submit" class="submit-btn" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner"></span>
                        <span>Signing in...</span>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z" />
                            <path fill-rule="evenodd"
                                d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z" />
                        </svg>
                        <span>Sign In</span>
                    }
                </button>
            </EditForm>
        </div>

        <p class="footer-text">Â© 2026 Shop Inventory System</p>
    </div>
</div>

<style>
    .login-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e1b4b 100%);
        padding: 2rem;
    }

    .login-container {
        width: 100%;
        max-width: 420px;
    }

    .login-card {
        background: white;
        border-radius: 1.5rem;
        padding: 2.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .login-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .logo {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        border-radius: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.25rem;
        color: white;
        box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4);
    }

    .login-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }

    .subtitle {
        color: #64748b;
        font-size: 0.9375rem;
    }

    .error-message {
        background: #fee2e2;
        border: 1px solid #fecaca;
        color: #991b1b;
        padding: 0.875rem 1rem;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .input-wrapper svg {
        position: absolute;
        left: 1rem;
        color: #9ca3af;
        pointer-events: none;
        transition: color 0.2s;
    }

    .form-input {
        width: 100%;
        padding: 0.875rem 1rem 0.875rem 3rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 0.9375rem;
        transition: all 0.2s;
        background: #f9fafb;
    }

    .form-input.password-input {
        padding-right: 3rem;
    }

    .password-toggle {
        position: absolute;
        right: 0.75rem;
        background: none;
        border: none;
        padding: 0.25rem;
        cursor: pointer;
        color: #9ca3af;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
        pointer-events: auto;
    }

    .password-toggle:hover {
        color: #4f46e5;
    }

    .password-toggle svg {
        position: static;
        pointer-events: auto;
    }

    .form-input:focus {
        outline: none;
        border-color: #4f46e5;
        background: white;
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    .form-input:focus+svg,
    .input-wrapper:focus-within svg {
        color: #4f46e5;
    }

    .form-input::placeholder {
        color: #9ca3af;
    }

    .validation-msg {
        color: #dc2626;
        font-size: 0.8125rem;
        margin-top: 0.375rem;
        display: block;
    }

    .submit-btn {
        width: 100%;
        padding: 0.875rem 1.5rem;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        border: none;
        border-radius: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.625rem;
        transition: all 0.2s;
        margin-top: 1.5rem;
        box-shadow: 0 4px 14px -3px rgba(79, 70, 229, 0.4);
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px -3px rgba(79, 70, 229, 0.5);
    }

    .submit-btn:active:not(:disabled) {
        transform: translateY(0);
    }

    .submit-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .footer-text {
        text-align: center;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.8125rem;
        margin-top: 2rem;
    }
</style>

@code {
    private LoginModel loginModel = new();
    private string? errorMessage;
    private bool isLoading = false;
    private bool showPassword = false;
    private bool isCheckingAuth = true;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Logger.LogDebug("Login page first render - checking if user is already authenticated");
            try
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                if (authState.User?.Identity?.IsAuthenticated == true)
                {
                    Logger.LogInformation("User {Username} is already authenticated, redirecting to home",
                    authState.User.Identity.Name);
                    var returnUrl = string.IsNullOrEmpty(ReturnUrl) ? "/" : ReturnUrl;
                    NavigationManager.NavigateTo(returnUrl, forceLoad: true);
                    return;
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error checking authentication state");
            }
            finally
            {
                isCheckingAuth = false;
                StateHasChanged();
            }
        }
    }

    private void TogglePassword()
    {
        showPassword = !showPassword;
    }

    private async Task HandleLogin()
    {
        Logger.LogInformation("HandleLogin started for user: {Username}", loginModel.Username);
        isLoading = true;
        errorMessage = null;

        try
        {
            Logger.LogDebug("Calling AuthService.LoginAsync");
            var (success, message, response) = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);
            Logger.LogInformation("LoginAsync returned: Success={Success}, Message={Message}", success, message);

            if (success && response != null)
            {
                Logger.LogInformation("Login successful, notifying auth state provider");
                // Notify the auth state provider about the new authentication
                AuthStateProvider.NotifyUserAuthentication(
                response.User?.Username ?? loginModel.Username,
                response.User?.Role ?? "User");

                Logger.LogDebug("Waiting 100ms for state to propagate");
                await Task.Delay(100);

                Logger.LogInformation("Navigating to home page with forceLoad=true");
                // Use forceLoad: true to force a full page reload so the auth state is properly initialized
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
            else
            {
                Logger.LogWarning("Login failed: {Message}", message);
                errorMessage = message;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Exception during HandleLogin");
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            Logger.LogDebug("HandleLogin completed, isLoading set to false");
        }
    }
}