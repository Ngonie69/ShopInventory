@page "/audit-trail"
@using ShopInventory.Web.Data
@using ShopInventory.Web.Services
@inject IAuditService AuditService
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<PageTitle>Audit Trail - Shop Inventory</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-journal-text me-2"></i>Audit Trail</h2>
        <div>
            <button class="btn btn-outline-secondary me-2" @onclick="RefreshLogs">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
            <button class="btn btn-outline-primary" @onclick="ExportLogs">
                <i class="bi bi-download me-1"></i>Export
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-2">
                    <FlexibleDatePicker Label="From Date" @bind-Date="fromDate" />
                </div>
                <div class="col-md-2">
                    <FlexibleDatePicker Label="To Date" @bind-Date="toDate" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">User</label>
                    <select class="form-select" @bind="selectedUser">
                        <option value="">All Users</option>
                        @foreach (var user in distinctUsers)
                        {
                            <option value="@user">@user</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Action</label>
                    <select class="form-select" @bind="selectedAction">
                        <option value="">All Actions</option>
                        @foreach (var action in distinctActions)
                        {
                            <option value="@action">@action</option>
                        }
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary me-2" @onclick="ApplyFilters">
                        <i class="bi bi-search me-1"></i>Search
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                        <i class="bi bi-x-circle me-1"></i>Clear
                    </button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-2">
                    <label class="form-label">Records per page</label>
                    <select class="form-select" @bind="pageSize" @bind:after="OnPageSizeChanged">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading audit logs...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
        </div>
    }
    else
    {
        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h3 class="mb-0">@totalCount</h3>
                        <small class="text-muted">Total Events</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h3 class="mb-0">@distinctUsers.Count</h3>
                        <small class="text-muted">Unique Users</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h3 class="mb-0">@distinctActions.Count</h3>
                        <small class="text-muted">Action Types</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h3 class="mb-0">@logs.Count(l => !l.IsSuccess)</h3>
                        <small class="text-muted">Failed Actions</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="card">
            <div class="card-body">
                @if (logs.Any())
                {
                    <MudDataGrid T="AuditLog" Items="@logs" SortMode="SortMode.Multiple" Filterable="true"
                        QuickFilter="@_quickFilter" Hideable="true" Dense="true" Hover="true" Striped="true">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">Audit Logs</MudText>
                            <MudSpacer />
                            <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start"
                                Immediate="true" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                                Class="mt-0"></MudTextField>
                        </ToolBarContent>
                        <Columns>
                            <PropertyColumn Property="x => x.Timestamp" Title="Timestamp">
                                <CellTemplate>
                                    <div>
                                        <MudText Typo="Typo.body2">@IAuditService.ToCAT(context.Item.Timestamp).ToString("dd MMM yyyy")</MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted">
                                            @IAuditService.ToCAT(context.Item.Timestamp).ToString("HH:mm:ss")</MudText>
                                    </div>
                                </CellTemplate>
                            </PropertyColumn>
                            <PropertyColumn Property="x => x.Username" Title="User">
                                <CellTemplate>
                                    <MudText Typo="Typo.body2"><strong>@context.Item.Username</strong></MudText>
                                </CellTemplate>
                            </PropertyColumn>
                            <PropertyColumn Property="x => x.UserRole" Title="Role">
                                <CellTemplate>
                                    <MudChip T="string" Color="@GetRoleChipColor(context.Item.UserRole)" Size="Size.Small">
                                        @context.Item.UserRole</MudChip>
                                </CellTemplate>
                            </PropertyColumn>
                            <PropertyColumn Property="x => x.Action" Title="Action">
                                <CellTemplate>
                                    <MudChip T="string" Color="@GetActionChipColor(context.Item.Action)" Size="Size.Small">
                                        @context.Item.Action</MudChip>
                                </CellTemplate>
                            </PropertyColumn>
                            <PropertyColumn Property="x => x.Details" Title="Details">
                                <CellTemplate>
                                    @if (!string.IsNullOrEmpty(context.Item.EntityType))
                                    {
                                        <span class="text-muted">@context.Item.EntityType</span>
                                        @if (!string.IsNullOrEmpty(context.Item.EntityId))
                                        {
                                            <span class="text-muted">: @context.Item.EntityId</span>
                                        }
                                    }
                                    @if (!string.IsNullOrEmpty(context.Item.Details))
                                    {
                                        <MudText Typo="Typo.caption" Class="d-block text-muted">@context.Item.Details</MudText>
                                    }
                                    @if (!context.Item.IsSuccess && !string.IsNullOrEmpty(context.Item.ErrorMessage))
                                    {
                                        <MudText Typo="Typo.caption" Class="d-block" Color="Color.Error">@context.Item.ErrorMessage
                                        </MudText>
                                    }
                                </CellTemplate>
                            </PropertyColumn>
                            <PropertyColumn Property="x => x.IsSuccess" Title="Status">
                                <CellTemplate>
                                    @if (context.Item.IsSuccess)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">
                                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" /> OK
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Error" Size="Size.Small">
                                            <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" /> Failed
                                        </MudChip>
                                    }
                                </CellTemplate>
                            </PropertyColumn>
                        </Columns>
                        <PagerContent>
                            <div class="d-flex flex-column align-items-center px-4 py-2">
                                <MudPagination Color="Color.Primary" Count="totalPages" Selected="currentPage"
                                    SelectedChanged="OnPageChanged" ShowFirstButton="true" ShowLastButton="true" />
                                <MudText Typo="Typo.caption" Class="text-muted mt-2">
                                    Page @currentPage of @totalPages (@totalCount total records)
                                </MudText>
                            </div>
                        </PagerContent>
                    </MudDataGrid>
                }
                else
                {
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-journal-x" style="font-size: 3rem;"></i>
                        <p class="mt-3">No audit logs found matching your criteria.</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private List<AuditLog> logs = new();
    private List<string> distinctUsers = new();
    private List<string> distinctActions = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string _searchString = string.Empty;

    // Filters
    private DateTime? fromDate;
    private DateTime? toDate;
    private string? selectedUser;
    private string? selectedAction;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 50;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    // Quick filter - filter globally across multiple columns with the same input
    private Func<AuditLog, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.Username?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (x.UserRole?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (x.Action?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (x.EntityType?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (x.Details?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        return false;
    };

    // Helper for role chip color
    private Color GetRoleChipColor(string role) => role switch
    {
        UserRoles.Admin => Color.Error,
        UserRoles.SalesPerson => Color.Primary,
        UserRoles.ADR => Color.Info,
        _ => Color.Default
    };

    // Helper for action chip color
    private Color GetActionChipColor(string action) => action switch
    {
        AuditActions.Login or AuditActions.Logout => Color.Success,
        AuditActions.LoginFailed => Color.Error,
        var a when a.StartsWith("Create") => Color.Primary,
        var a when a.StartsWith("Update") => Color.Warning,
        var a when a.StartsWith("Delete") => Color.Error,
        var a when a.StartsWith("View") => Color.Info,
        var a when a.StartsWith("Sync") => Color.Default,
        _ => Color.Default
    };

    protected override async Task OnInitializedAsync()
    {
        // Set default date range to last 7 days in CAT timezone
        var catNow = IAuditService.ToCAT(DateTime.UtcNow);
        toDate = catNow.Date;
        fromDate = catNow.Date.AddDays(-7);

        await LoadFilterOptions();
        await LoadLogs();
        await LogViewAudit();
    }

    private async Task LoadFilterOptions()
    {
        try
        {
            distinctUsers = await AuditService.GetDistinctUsersAsync();
            distinctActions = await AuditService.GetDistinctActionsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load filter options: {ex.Message}";
        }
    }

    private async Task LoadLogs()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            totalCount = await AuditService.GetLogCountAsync(fromDate, toDate, selectedUser, selectedAction);
            logs = await AuditService.GetLogsAsync(fromDate, toDate, selectedUser, selectedAction, currentPage, pageSize);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load audit logs: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadLogs();
    }

    private async Task ClearFilters()
    {
        var catNow = IAuditService.ToCAT(DateTime.UtcNow);
        fromDate = catNow.Date.AddDays(-7);
        toDate = catNow.Date;
        selectedUser = null;
        selectedAction = null;
        currentPage = 1;
        await LoadLogs();
    }

    private async Task RefreshLogs()
    {
        await LoadFilterOptions();
        await LoadLogs();
    }

    private async Task OnPageChanged(int page)
    {
        await GoToPage(page);
    }

    private async Task GoToPage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadLogs();
    }

    private async Task OnPageSizeChanged()
    {
        currentPage = 1;
        await LoadLogs();
    }
    private Task ExportLogs()
    {
        // TODO: Implement CSV export
        return Task.CompletedTask;
    }

    private string GetRoleBadgeClass(string role) => role switch
    {
        UserRoles.Admin => "bg-danger",
        UserRoles.SalesPerson => "bg-primary",
        UserRoles.ADR => "bg-info",
        _ => "bg-secondary"
    };

    private string GetActionBadgeClass(string action) => action switch
    {
        AuditActions.Login or AuditActions.Logout => "bg-success",
        AuditActions.LoginFailed => "bg-danger",
        var a when a.StartsWith("Create") => "bg-primary",
        var a when a.StartsWith("Update") => "bg-warning text-dark",
        var a when a.StartsWith("Delete") => "bg-danger",
        var a when a.StartsWith("View") => "bg-info",
        var a when a.StartsWith("Sync") => "bg-secondary",
        _ => "bg-light text-dark"
    };

    private async Task LogViewAudit()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var username = authState.User.Identity?.Name ?? "Unknown";
        var role = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "Unknown";
        await AuditService.LogAsync(AuditActions.ViewAuditTrail, username, role, "AuditLog", null, null, "/audit-trail");
    }
}