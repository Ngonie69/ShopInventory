@page "/customer-portal/login"
@using System.ComponentModel.DataAnnotations
@using ShopInventory.Web.Models
@inject ICustomerAuthService CustomerAuthService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ILogger<CustomerLogin> Logger
@attribute [AllowAnonymous]
@rendermode InteractiveServer
@layout EmptyLayout

<PageTitle>Customer Portal Login - Shop Inventory</PageTitle>

<div class="customer-login-page auth-page">
    <div class="auth-shell">
        <section class="auth-visual">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>
            <div class="orb orb-3"></div>
            <div class="orb orb-4"></div>
            <div class="visual-content">
                <div class="visual-brand">
                    <div class="brand-logo">
                        <img src="images/kefalos-logo.jpg" alt="Kefalos" />
                    </div>
                    <div class="brand-text">
                        <span class="brand-name">Kefalos Network</span>
                        <span class="brand-tag">Customer Portal</span>
                    </div>
                </div>
                <div class="visual-card">
                    <p class="visual-eyebrow">Customer Access</p>
                    <h2>Statements, invoices, and balances.</h2>
                    <p class="visual-copy">
                        Check account activity, download statements, and manage payments anytime.
                    </p>
                    <div class="visual-footer">
                        <span>Staff access?</span>
                        <a class="visual-link" href="/login">Staff login &rarr;</a>
                    </div>
                </div>
            </div>
        </section>

        <section class="auth-form">
            <div class="login-header">
                <span class="eyebrow">Customer Portal</span>
                <h1>@(showTwoFactor ? "Verify your access" : "Sign in")</h1>
                <p class="subtitle">
                    @(showTwoFactor
                                        ? "Enter the 6-digit code sent to your email."
                                        : "Use your customer code or email to access your account.")
                </p>
            </div>

            @if (showTwoFactor)
            {
                <div class="two-factor-section">
                    <div class="info-message">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path
                                d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
                        </svg>
                        <span>A verification code has been sent to your email</span>
                    </div>

                    <EditForm Model="twoFactorModel" OnValidSubmit="HandleTwoFactorVerification" FormName="TwoFactorForm">
                        <DataAnnotationsValidator />

                        <div class="form-group">
                            <label for="verificationCode">Verification Code</label>
                            <div class="input-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                    viewBox="0 0 16 16">
                                    <path
                                        d="M3 2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2zm1 1v10h8V3H4zm3 2h2v2H7V5zm0 3h2v2H7V8z" />
                                </svg>
                                <InputText id="verificationCode" class="form-input verification-code"
                                    @bind-Value="twoFactorModel.Code" placeholder="000000" maxlength="6" />
                            </div>
                            <ValidationMessage For="@(() => twoFactorModel.Code)" class="validation-msg" />
                        </div>

                        <button type="submit" class="submit-btn" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner"></span>
                                <span>Verifying...</span>
                            }
                            else
                            {
                                <span>Verify code</span>
                            }
                        </button>

                        <button type="button" class="link-btn" @onclick="BackToLogin">
                            &larr; Back to login
                        </button>
                    </EditForm>
                </div>
            }
            else
            {
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                        </svg>
                        <span>@errorMessage</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="success-message">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
                        </svg>
                        <span>@successMessage</span>
                    </div>
                }

                <EditForm Model="loginModel" OnValidSubmit="HandleLogin" FormName="CustomerLoginForm">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label for="cardCode">Customer Code or Email</label>
                        <div class="input-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                viewBox="0 0 16 16">
                                <path
                                    d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z" />
                            </svg>
                            <InputText id="cardCode" class="form-input" @bind-Value="loginModel.CardCode"
                                placeholder="Enter your customer code or email" autocomplete="username" />
                        </div>
                        <ValidationMessage For="@(() => loginModel.CardCode)" class="validation-msg" />
                    </div>

                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="input-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                viewBox="0 0 16 16">
                                <path
                                    d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
                            </svg>
                            <input id="password" type="@(showPassword ? "text" : "password")"
                                class="form-input password-input" @bind="loginModel.Password"
                                placeholder="Enter your password" autocomplete="current-password" />
                            <button type="button" class="password-toggle" @onclick="TogglePassword" tabindex="-1">
                                @if (showPassword)
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                        viewBox="0 0 16 16">
                                        <path
                                            d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z" />
                                        <path
                                            d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z" />
                                        <path
                                            d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z" />
                                    </svg>
                                }
                                else
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                        viewBox="0 0 16 16">
                                        <path
                                            d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z" />
                                        <path
                                            d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z" />
                                    </svg>
                                }
                            </button>
                        </div>
                        <ValidationMessage For="@(() => loginModel.Password)" class="validation-msg" />
                    </div>

                    <button type="submit" class="submit-btn" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner"></span>
                            <span>Signing in...</span>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z" />
                                <path fill-rule="evenodd"
                                    d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z" />
                            </svg>
                            <span>Sign in to portal</span>
                        }
                    </button>
                </EditForm>

                <div class="login-footer">
                    <a href="/customer-portal/forgot-password" class="forgot-password-link">Forgot your password?</a>
                    <a href="/login" class="staff-login-link">Staff login &rarr;</a>
                </div>
            }

            <div class="security-notice">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.777 11.777 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.159 7.159 0 0 0 1.048-.625 11.775 11.775 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.541 1.541 0 0 0-1.044-1.263 62.467 62.467 0 0 0-2.887-.87C9.843.266 8.69 0 8 0zm-.5 5a.5.5 0 0 1 1 0v1.5H10a.5.5 0 0 1 0 1H8.5V9a.5.5 0 0 1-1 0V7.5H6a.5.5 0 0 1 0-1h1.5V5z" />
                </svg>
                <span>Secured with 256-bit encryption</span>
            </div>

            <p class="footer-text">Â© 2026 Shop Inventory System - Customer Portal</p>
        </section>
    </div>
</div>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap');

    .customer-login-page.auth-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2.5rem 1.5rem;
        background: linear-gradient(135deg, #0b0b0b 0%, #151515 45%, #242424 100%);
        font-family: "Outfit", "Segoe UI", sans-serif;
        color: #111111;
    }

    .auth-shell {
        width: min(1100px, 100%);
        min-height: 640px;
        background: #ffffff;
        border-radius: 28px;
        overflow: hidden;
        display: grid;
        grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
        box-shadow: 0 40px 90px rgba(0, 0, 0, 0.35);
    }

    .auth-visual {
        position: relative;
        padding: 3rem;
        background:
            radial-gradient(circle at 18% 20%, rgba(255, 255, 255, 0.22), rgba(255, 255, 255, 0) 45%),
            radial-gradient(circle at 85% 18%, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0) 40%),
            radial-gradient(circle at 20% 85%, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0) 50%),
            linear-gradient(145deg, #0b0b0b 0%, #1a1a1a 55%, #111111 100%);
        color: #f5f5f5;
        overflow: hidden;
    }

    .auth-visual::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
        pointer-events: none;
    }

    .orb {
        position: absolute;
        border-radius: 50%;
        opacity: 0.95;
        animation: float 12s ease-in-out infinite;
    }

    .orb-1 {
        width: 170px;
        height: 170px;
        top: -40px;
        left: -20px;
        background: radial-gradient(circle at 30% 30%, #f5f5f5, #9c9c9c);
        animation-delay: 0s;
    }

    .orb-2 {
        width: 120px;
        height: 120px;
        top: 40px;
        right: 60px;
        background: radial-gradient(circle at 30% 30%, #ededed, #7d7d7d);
        animation-delay: 1.5s;
    }

    .orb-3 {
        width: 220px;
        height: 220px;
        bottom: -90px;
        left: 35%;
        background: radial-gradient(circle at 30% 30%, #d6d6d6, #4a4a4a);
        animation-delay: 3s;
    }

    .orb-4 {
        width: 140px;
        height: 140px;
        bottom: 40px;
        right: -30px;
        border: 14px solid rgba(255, 255, 255, 0.35);
        background: transparent;
        animation-delay: 2.2s;
    }

    .visual-content {
        position: relative;
        z-index: 1;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 2rem;
    }

    .visual-brand {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .brand-logo {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }

    .brand-logo img {
        width: 40px;
        height: auto;
    }

    .brand-text {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .brand-name {
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        font-size: 1.05rem;
        font-weight: 600;
        letter-spacing: 0.02em;
    }

    .brand-tag {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.72);
    }

    .visual-card {
        background: rgba(17, 17, 17, 0.62);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 2rem;
        border-radius: 22px;
        box-shadow: 0 22px 50px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(12px);
        animation: fadeUp 0.8s ease-out;
    }

    .visual-eyebrow {
        text-transform: uppercase;
        font-size: 0.72rem;
        letter-spacing: 0.25em;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 0.75rem;
    }

    .visual-card h2 {
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        font-size: 2rem;
        margin: 0 0 0.75rem;
    }

    .visual-copy {
        color: rgba(245, 245, 245, 0.78);
        line-height: 1.6;
        margin: 0;
    }

    .visual-footer {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 1.5rem;
        font-size: 0.95rem;
    }

    .visual-link {
        color: #ffffff;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
    }

    .visual-link:hover {
        color: #d4d4d4;
    }

    .auth-form {
        padding: 3.5rem 3rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 1.5rem;
    }

    .login-header h1 {
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
        font-size: 2.2rem;
        margin: 0.5rem 0 0.4rem;
    }

    .eyebrow {
        display: inline-flex;
        align-items: center;
        padding: 0.3rem 0.85rem;
        border-radius: 999px;
        background: #111111;
        color: #ffffff;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }

    .subtitle {
        color: #525252;
        margin: 0;
        font-size: 1rem;
    }

    .error-message {
        background: #f2f2f2;
        border: 1px solid #e0e0e0;
        color: #111111;
        padding: 0.9rem 1rem;
        border-radius: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
    }

    .success-message {
        background: #f2f2f2;
        border: 1px solid #e0e0e0;
        color: #111111;
        padding: 0.9rem 1rem;
        border-radius: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
    }

    .info-message {
        background: #f2f2f2;
        border: 1px solid #e0e0e0;
        color: #111111;
        padding: 0.9rem 1rem;
        border-radius: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
    }

    .form-group {
        margin-bottom: 1.2rem;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        color: #1f1f1f;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .input-wrapper > svg {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #8b8b8b;
        pointer-events: none;
        transition: color 0.2s;
    }

    .form-input {
        width: 100%;
        padding: 0.9rem 1rem 0.9rem 2.9rem;
        border: 1px solid #d6d6d6;
        border-radius: 0.9rem;
        font-size: 0.95rem;
        transition: all 0.2s;
        background: #f4f4f4;
    }

    .form-input:focus {
        outline: none;
        border-color: #111111;
        background: #ffffff;
        box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.2);
    }

    .form-input::placeholder {
        color: #9b9b9b;
    }

    .form-input.password-input {
        padding-right: 3rem;
    }

    .password-toggle {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        z-index: 2;
        background: none;
        border: none;
        cursor: pointer;
        color: #8b8b8b;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
    }

    .password-toggle:hover {
        color: #111111;
    }

    .password-toggle svg {
        position: static;
        pointer-events: auto;
    }

    .verification-code {
        text-align: center;
        font-size: 1.5rem;
        letter-spacing: 0.5em;
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
    }

    .validation-msg {
        color: #2b2b2b;
        font-size: 0.8rem;
        margin-top: 0.4rem;
    }

    .submit-btn {
        width: 100%;
        padding: 0.95rem 1.5rem;
        background: linear-gradient(90deg, #0f0f0f, #2a2a2a);
        color: #ffffff;
        border: none;
        border-radius: 0.9rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 1.4rem;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.3);
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 18px 34px rgba(0, 0, 0, 0.4);
    }

    .submit-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .link-btn {
        width: 100%;
        padding: 0.75rem;
        background: transparent;
        color: #111111;
        border: none;
        font-size: 0.9rem;
        cursor: pointer;
        margin-top: 1rem;
    }

    .link-btn:hover {
        text-decoration: underline;
    }

    .login-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #d6d6d6;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .forgot-password-link,
    .staff-login-link {
        color: #111111;
        font-size: 0.9rem;
        text-decoration: none;
        transition: color 0.2s;
    }

    .forgot-password-link:hover,
    .staff-login-link:hover {
        color: #000000;
        text-decoration: underline;
    }

    .security-notice {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding-top: 1rem;
        border-top: 1px solid #d6d6d6;
        color: #2b2b2b;
        font-size: 0.78rem;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.35);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .footer-text {
        text-align: center;
        color: #9b9b9b;
        font-size: 0.85rem;
        margin: 0;
    }

    .two-factor-section {
        animation: fadeIn 0.3s ease-out;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @@keyframes float {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-12px);
        }
    }

    @@keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(16px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@media (max-width: 1024px) {
        .auth-shell {
            grid-template-columns: 1fr;
        }

        .auth-visual {
            min-height: 280px;
        }
    }

    @@media (max-width: 640px) {
        .auth-form {
            padding: 2.5rem 1.5rem;
        }

        .auth-visual {
            padding: 2rem;
        }

        .visual-card {
            padding: 1.6rem;
        }

        .visual-card h2 {
            font-size: 1.6rem;
        }
    }
</style>

@code {
    private CustomerLoginModel loginModel = new();
    private TwoFactorModel twoFactorModel = new();
    private bool showPassword = false;
    private bool isLoading = false;
    private string? errorMessage;
    private string? successMessage;
    private bool showTwoFactor = false;
    private string? twoFactorToken;

    private class CustomerLoginModel
    {
        [Required(ErrorMessage = "Customer code is required")]
        [StringLength(50, MinimumLength = 1, ErrorMessage = "Customer code must be between 1 and 50 characters")]
        public string CardCode { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "Password must be at least 8 characters")]
        public string Password { get; set; } = string.Empty;
    }

    private class TwoFactorModel
    {
        [Required(ErrorMessage = "Verification code is required")]
        [StringLength(6, MinimumLength = 6, ErrorMessage = "Code must be 6 digits")]
        public string Code { get; set; } = string.Empty;
    }

    private void TogglePassword()
    {
        showPassword = !showPassword;
    }

    private async Task HandleLogin()
    {
        if (isLoading) return;

        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var ipAddress = "127.0.0.1"; // In production, get from HttpContext
            var userAgent = await JSRuntime.InvokeAsync<string>("eval", "navigator.userAgent");

            var request = new CustomerLoginRequest
            {
                CardCode = loginModel.CardCode,
                Password = loginModel.Password
            };

            var response = await CustomerAuthService.LoginAsync(request, ipAddress, userAgent);

            if (response.Success)
            {
                if (response.RequiresTwoFactor)
                {
                    twoFactorToken = response.TwoFactorToken;
                    showTwoFactor = true;
                    successMessage = response.Message;
                }
                else
                {
                    // Store tokens and navigate to dashboard
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "customerToken", response.AccessToken);
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "customerRefreshToken", response.RefreshToken);
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "customerInfo",
                    System.Text.Json.JsonSerializer.Serialize(response.Customer));

                    NavigationManager.NavigateTo("/customer-portal/dashboard", forceLoad: true);
                }
            }
            else
            {
                errorMessage = response.Message;
                Logger.LogWarning("Customer login failed for {CardCode}: {Message}", loginModel.CardCode, response.Message);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during customer login");
            errorMessage = "An error occurred during login. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleTwoFactorVerification()
    {
        if (isLoading || string.IsNullOrEmpty(twoFactorToken)) return;

        isLoading = true;
        errorMessage = null;

        try
        {
            var ipAddress = "127.0.0.1";
            var userAgent = await JSRuntime.InvokeAsync<string>("eval", "navigator.userAgent");

            var request = new CustomerTwoFactorRequest
            {
                Code = twoFactorModel.Code,
                TwoFactorToken = twoFactorToken
            };

            var response = await CustomerAuthService.VerifyTwoFactorAsync(request, ipAddress, userAgent);

            if (response.Success)
            {
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "customerToken", response.AccessToken);
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "customerRefreshToken", response.RefreshToken);
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "customerInfo",
                System.Text.Json.JsonSerializer.Serialize(response.Customer));

                NavigationManager.NavigateTo("/customer-portal/dashboard", forceLoad: true);
            }
            else
            {
                errorMessage = response.Message;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during 2FA verification");
            errorMessage = "An error occurred during verification. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void BackToLogin()
    {
        showTwoFactor = false;
        twoFactorToken = null;
        twoFactorModel = new TwoFactorModel();
        errorMessage = null;
        successMessage = null;
    }
}
