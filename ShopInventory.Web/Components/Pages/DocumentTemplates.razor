@page "/document-templates"
@using Microsoft.AspNetCore.Authorization
@using ShopInventory.Web.Models
@attribute [Authorize]
@inject HttpClient Http
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Document Templates - Shop Inventory</PageTitle>

<div class="container-fluid fade-in">
    <div class="page-header">
        <h2>
            <i class="bi bi-file-earmark-text me-2" style="color: var(--primary-color);"></i>
            Document Templates
        </h2>
        <span class="text-muted">Manage customizable templates for invoices, quotes, and other documents</span>
    </div>

    <!-- Action Bar -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="btn-group">
            <button class="btn @(selectedDocumentType == null ? "btn-primary" : "btn-outline-primary")"
                @onclick='() => FilterByType(null)'>
                All Templates
            </button>
            <button class="btn @(selectedDocumentType == "Invoice" ? "btn-primary" : "btn-outline-primary")"
                @onclick='() => FilterByType("Invoice")'>
                Invoice
            </button>
            <button class="btn @(selectedDocumentType == "Quote" ? "btn-primary" : "btn-outline-primary")"
                @onclick='() => FilterByType("Quote")'>
                Quote
            </button>
            <button class="btn @(selectedDocumentType == "SalesOrder" ? "btn-primary" : "btn-outline-primary")"
                @onclick='() => FilterByType("SalesOrder")'>
                Sales Order
            </button>
            <button class="btn @(selectedDocumentType == "DeliveryNote" ? "btn-primary" : "btn-outline-primary")"
                @onclick='() => FilterByType("DeliveryNote")'>
                Delivery Note
            </button>
        </div>
        <button class="btn btn-primary" @onclick="OpenCreateModal">
            <i class="bi bi-plus-circle me-2"></i>Create Template
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading templates...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
        </div>
    }
    else if (templates?.Any() == true)
    {
        <div class="row g-4">
            @foreach (var template in templates)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 @(template.IsDefault ? "border-primary" : "")">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title mb-0">@template.Name</h5>
                                @if (template.IsDefault)
                                {
                                    <span class="badge bg-primary">Default</span>
                                }
                                @if (!template.IsActive)
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </div>
                            <p class="card-text">
                                <span class="badge bg-info">@template.DocumentType</span>
                                <small class="text-muted ms-2">@template.PaperSize - @template.Orientation</small>
                            </p>
                            <div class="mb-3">
                                <small class="text-muted">
                                    <i class="bi bi-calendar me-1"></i>Created: @template.CreatedAt.ToLocalTime().ToString("g")
                                </small>
                                @if (template.UpdatedAt.HasValue)
                                {
                                    <br />
                                    <small class="text-muted">
                                        <i class="bi bi-pencil me-1"></i>Updated:
                                        @template.UpdatedAt.Value.ToLocalTime().ToString("g")
                                    </small>
                                }
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100">
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => PreviewTemplate(template)">
                                    <i class="bi bi-eye"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => EditTemplate(template)">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                @if (!template.IsDefault)
                                {
                                    <button class="btn btn-sm btn-outline-success" @onclick="() => SetAsDefault(template.Id)">
                                        <i class="bi bi-star"></i>
                                    </button>
                                }
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTemplate(template.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">
                            Previous
                        </button>
                    </li>
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        var pageNum = i;
                        <li class="page-item @(currentPage == pageNum ? "active" : "")">
                            <button class="page-link" @onclick="() => ChangePage(pageNum)">@pageNum</button>
                        </li>
                    }
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage + 1)"
                            disabled="@(currentPage == totalPages)">
                            Next
                        </button>
                    </li>
                </ul>
            </nav>
        }
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>No templates found. Create your first template to get started.
        </div>
    }
</div>

<!-- Create/Edit Template Modal -->
@if (showTemplateModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingTemplate == null ? "Create Template" : "Edit Template")</h5>
                    <button type="button" class="btn-close" @onclick="CloseTemplateModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Template Name *</label>
                            <input type="text" class="form-control" @bind="templateName"
                                placeholder="e.g., Default Invoice Template" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Document Type *</label>
                            <select class="form-select" @bind="templateDocumentType">
                                <option value="">Select type...</option>
                                <option value="Invoice">Invoice</option>
                                <option value="Quote">Quote</option>
                                <option value="SalesOrder">Sales Order</option>
                                <option value="PurchaseOrder">Purchase Order</option>
                                <option value="DeliveryNote">Delivery Note</option>
                                <option value="CreditNote">Credit Note</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Paper Size</label>
                            <select class="form-select" @bind="templatePaperSize">
                                <option value="A4">A4</option>
                                <option value="Letter">Letter</option>
                                <option value="Legal">Legal</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Orientation</label>
                            <select class="form-select" @bind="templateOrientation">
                                <option value="Portrait">Portrait</option>
                                <option value="Landscape">Landscape</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" @bind="templateIsDefault"
                                    id="templateIsDefault">
                                <label class="form-check-label" for="templateIsDefault">
                                    Set as default template
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="templateIsActive"
                                    id="templateIsActive">
                                <label class="form-check-label" for="templateIsActive">
                                    Active
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Header Content (HTML)</label>
                            <textarea class="form-control" @bind="templateHeaderContent" rows="3"
                                placeholder="Company logo, address, contact info..."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Main Content (HTML) *</label>
                            <button class="btn btn-sm btn-outline-secondary float-end" @onclick="ShowPlaceholders">
                                <i class="bi bi-question-circle"></i> Placeholders
                            </button>
                            <textarea class="form-control" @bind="templateHtmlContent" rows="10"
                                placeholder="Use {{PlaceholderName}} for dynamic content..."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Footer Content (HTML)</label>
                            <textarea class="form-control" @bind="templateFooterContent" rows="3"
                                placeholder="Terms, conditions, signature blocks..."></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">CSS Styles</label>
                            <textarea class="form-control" @bind="templateCssStyles" rows="5"
                                placeholder=".header { font-size: 24px; } ..."></textarea>
                        </div>
                    </div>
                    @if (savingError != null)
                    {
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>@savingError
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseTemplateModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveTemplate" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<DocumentTemplateDto>? templates;
    private bool isLoading = true;
    private string? errorMessage;
    private string? selectedDocumentType;
    private int currentPage = 1;
    private int pageSize = 12;
    private int totalCount;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    // Modal state
    private bool showTemplateModal;
    private bool isSaving;
    private string? savingError;
    private DocumentTemplateDto? editingTemplate;

    // Form fields
    private string templateName = "";
    private string templateDocumentType = "";
    private string templateHtmlContent = "";
    private string? templateCssStyles;
    private string? templateHeaderContent;
    private string? templateFooterContent;
    private string templatePaperSize = "A4";
    private string templateOrientation = "Portrait";
    private bool templateIsDefault;
    private bool templateIsActive = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
    }

    private async Task LoadTemplates()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            var url = $"/api/document/templates?page={currentPage}&pageSize={pageSize}";
            if (!string.IsNullOrEmpty(selectedDocumentType))
            {
                url += $"&documentType={selectedDocumentType}";
            }

            var response = await Http.GetFromJsonAsync<DocumentTemplateListResponseDto>(url);
            templates = response?.Templates;
            totalCount = response?.TotalCount ?? 0;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading templates: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task FilterByType(string? documentType)
    {
        selectedDocumentType = documentType;
        currentPage = 1;
        await LoadTemplates();
    }

    private async Task ChangePage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadTemplates();
        }
    }

    private void OpenCreateModal()
    {
        editingTemplate = null;
        templateName = "";
        templateDocumentType = "";
        templateHtmlContent = "";
        templateCssStyles = null;
        templateHeaderContent = null;
        templateFooterContent = null;
        templatePaperSize = "A4";
        templateOrientation = "Portrait";
        templateIsDefault = false;
        templateIsActive = true;
        savingError = null;
        showTemplateModal = true;
    }

    private void EditTemplate(DocumentTemplateDto template)
    {
        editingTemplate = template;
        templateName = template.Name;
        templateDocumentType = template.DocumentType;
        templateHtmlContent = template.HtmlContent;
        templateCssStyles = template.CssStyles;
        templateHeaderContent = template.HeaderContent;
        templateFooterContent = template.FooterContent;
        templatePaperSize = template.PaperSize;
        templateOrientation = template.Orientation;
        templateIsDefault = template.IsDefault;
        templateIsActive = template.IsActive;
        savingError = null;
        showTemplateModal = true;
    }

    private void CloseTemplateModal()
    {
        showTemplateModal = false;
    }

    private async Task SaveTemplate()
    {
        isSaving = true;
        savingError = null;

        try
        {
            var request = new UpsertDocumentTemplateRequest
            {
                Name = templateName,
                DocumentType = templateDocumentType,
                HtmlContent = templateHtmlContent,
                CssStyles = templateCssStyles,
                HeaderContent = templateHeaderContent,
                FooterContent = templateFooterContent,
                PaperSize = templatePaperSize,
                Orientation = templateOrientation,
                IsDefault = templateIsDefault,
                IsActive = templateIsActive
            };

            HttpResponseMessage response;
            if (editingTemplate == null)
            {
                response = await Http.PostAsJsonAsync("/api/document/templates", request);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"/api/document/templates/{editingTemplate.Id}", request);
            }

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Template saved successfully!");
                CloseTemplateModal();
                await LoadTemplates();
            }
            else
            {
                savingError = "Failed to save template. Please try again.";
            }
        }
        catch (Exception ex)
        {
            savingError = $"Error: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task SetAsDefault(int templateId)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Set this template as default?"))
        {
            try
            {
                var response = await Http.PostAsync($"/api/document/templates/{templateId}/set-default", null);
                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "Template set as default!");
                    await LoadTemplates();
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            }
        }
    }

    private async Task DeleteTemplate(int templateId)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this template?"))
        {
            try
            {
                var response = await Http.DeleteAsync($"/api/document/templates/{templateId}");
                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "Template deleted successfully!");
                    await LoadTemplates();
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            }
        }
    }

    private async Task PreviewTemplate(DocumentTemplateDto template)
    {
        await JS.InvokeVoidAsync("alert", "Preview functionality coming soon!");
    }

    private async Task ShowPlaceholders()
    {
        if (string.IsNullOrEmpty(templateDocumentType))
        {
            await JS.InvokeVoidAsync("alert", "Please select a document type first.");
            return;
        }

        try
        {
            var placeholders = await Http.GetFromJsonAsync<TemplatePlaceholdersDto>(
            $"/api/document/templates/placeholders/{templateDocumentType}");

            var message = "Available Placeholders:\n\n";
            foreach (var group in placeholders.Placeholders.GroupBy(p => p.Category))
            {
                message += $"{group.Key}:\n";
                foreach (var p in group)
                {
                    message += $" {{{{{p.Key}}}}} - {p.Description}\n";
                }
                message += "\n";
            }

            await JS.InvokeVoidAsync("alert", message);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading placeholders: {ex.Message}");
        }
    }

    public class DocumentTemplateDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string DocumentType { get; set; } = string.Empty;
        public string HtmlContent { get; set; } = string.Empty;
        public string? CssStyles { get; set; }
        public string? HeaderContent { get; set; }
        public string? FooterContent { get; set; }
        public string PaperSize { get; set; } = "A4";
        public string Orientation { get; set; } = "Portrait";
        public bool IsDefault { get; set; }
        public bool IsActive { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
    }

    public class DocumentTemplateListResponseDto
    {
        public List<DocumentTemplateDto> Templates { get; set; } = new();
        public int TotalCount { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
    }

    public class UpsertDocumentTemplateRequest
    {
        public string Name { get; set; } = string.Empty;
        public string DocumentType { get; set; } = string.Empty;
        public string HtmlContent { get; set; } = string.Empty;
        public string? CssStyles { get; set; }
        public string? HeaderContent { get; set; }
        public string? FooterContent { get; set; }
        public string PaperSize { get; set; } = "A4";
        public string Orientation { get; set; } = "Portrait";
        public bool IsDefault { get; set; }
        public bool IsActive { get; set; } = true;
    }

    public class TemplatePlaceholdersDto
    {
        public string DocumentType { get; set; } = string.Empty;
        public List<PlaceholderDto> Placeholders { get; set; } = new();
    }

    public class PlaceholderDto
    {
        public string Key { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Example { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
    }
}