@page "/users"
@using ShopInventory.Web.Models
@using ShopInventory.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject IUserManagementService UserService
@inject IAuditService AuditService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>User Management - Shop Inventory</PageTitle>

<div class="container-fluid fade-in">
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16"
                    style="color: var(--primary-color);">
                    <path
                        d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8Zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022ZM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816ZM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275ZM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0Zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z" />
                </svg>
                User Management
            </h2>
            <span class="text-muted">Manage system users and permissions</span>
        </div>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="bi bi-plus-circle me-2"></i>Add User
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Search users..." @bind="searchTerm"
                            @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="roleFilter" @bind:after="LoadUsers">
                        <option value="">All Roles</option>
                        @foreach (var role in availableRoles)
                        {
                            <option value="@role">@role</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="statusFilter" @bind:after="LoadUsers">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="locked">Locked</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" @onclick="ResetFilters">
                        <i class="bi bi-arrow-clockwise me-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-body">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (users.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Created</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in users)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-3 @(user.IsActive ? "bg-primary" : "bg-secondary")">
                                                @user.Username.Substring(0, 1).ToUpper()
                                            </div>
                                            <div>
                                                <strong>@user.Username</strong>
                                                <br><small class="text-muted">@user.Email</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge @GetRoleBadgeClass(user.Role)">@user.Role</span>
                                    </td>
                                    <td>
                                        @if (user.IsLocked)
                                        {
                                            <span class="badge bg-danger">Locked</span>
                                        }
                                        else if (user.IsActive)
                                        {
                                            <span class="badge bg-success">Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactive</span>
                                        }
                                    </td>
                                    <td>
                                        @if (user.LastLoginAt.HasValue)
                                        {
                                            <span title="@user.LastLoginAt.Value.ToString("dd MMM yyyy HH:mm")">@user.TimeAgo</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Never</span>
                                        }
                                    </td>
                                    <td>@user.CreatedAt.ToString("dd MMM yyyy")</td>
                                    <td class="text-end">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowEditModal(user)"
                                                title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning"
                                                @onclick="() => ShowPasswordModal(user)" title="Change Password">
                                                <i class="bi bi-key"></i>
                                            </button>
                                            @if (user.IsLocked)
                                            {
                                                <button class="btn btn-sm btn-outline-success" @onclick="() => UnlockUser(user)"
                                                    title="Unlock">
                                                    <i class="bi bi-unlock"></i>
                                                </button>
                                            }
                                            @if (user.IsActive)
                                            {
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    @onclick="() => DeactivateUser(user)" title="Deactivate">
                                                    <i class="bi bi-person-slash"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-outline-success" @onclick="() => ActivateUser(user)"
                                                    title="Activate">
                                                    <i class="bi bi-person-check"></i>
                                                </button>
                                            }
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(user)"
                                                title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <button class="page-link" @onclick="() => GoToPage(currentPage - 1)">Previous</button>
                            </li>
                            @for (int i = 1; i <= totalPages; i++)
                            {
                                var pageNum = i;
                                <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                    <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                                </li>
                            }
                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <button class="page-link" @onclick="() => GoToPage(currentPage + 1)">Next</button>
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-people display-4 text-muted"></i>
                    <p class="mt-3 text-muted">No users found</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
@if (showUserModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditing ? "Edit User" : "Create User")</h5>
                    <button type="button" class="btn-close" @onclick="CloseUserModal"></button>
                </div>
                <EditForm Model="userForm" OnValidSubmit="SaveUser">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <InputText class="form-control" @bind-Value="userForm.Username" disabled="@isEditing" />
                            <ValidationMessage For="() => userForm.Username" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <InputText class="form-control" @bind-Value="userForm.Email" />
                            <ValidationMessage For="() => userForm.Email" />
                        </div>
                        @if (!isEditing)
                        {
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <InputText type="password" class="form-control" @bind-Value="userForm.Password" />
                                <ValidationMessage For="() => userForm.Password" />
                            </div>
                        }
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <InputSelect class="form-select" @bind-Value="userForm.Role">
                                @foreach (var role in availableRoles)
                                {
                                    <option value="@role">@role</option>
                                }
                            </InputSelect>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseUserModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            @(isEditing ? "Update" : "Create")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- Change Password Modal -->
@if (showPasswordModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password for @selectedUser?.Username</h5>
                    <button type="button" class="btn-close" @onclick="ClosePasswordModal"></button>
                </div>
                <EditForm Model="passwordForm" OnValidSubmit="ChangePassword">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <InputText type="password" class="form-control" @bind-Value="passwordForm.NewPassword" />
                            <ValidationMessage For="() => passwordForm.NewPassword" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm Password</label>
                            <InputText type="password" class="form-control" @bind-Value="passwordForm.ConfirmPassword" />
                            <ValidationMessage For="() => passwordForm.ConfirmPassword" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="ClosePasswordModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Change Password
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="() => showDeleteModal = false"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete user <strong>@selectedUser?.Username</strong>?</p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showDeleteModal = false">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteUser" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Delete User
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Alert Message -->
@if (!string.IsNullOrEmpty(alertMessage))
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
        <div class="toast show @(alertSuccess ? "bg-success" : "bg-danger") text-white">
            <div class="toast-body d-flex justify-content-between align-items-center">
                <span>@alertMessage</span>
                <button type="button" class="btn-close btn-close-white ms-3" @onclick="() => alertMessage = null"></button>
            </div>
        </div>
    </div>
}

<style>
    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
    }
</style>

@code {
    private List<UserModel> users = new();
    private List<string> availableRoles = new() { "Admin", "Manager", "User", "ReadOnly" };
    private bool isLoading = true;
    private bool isSaving = false;
    private bool showUserModal = false;
    private bool showPasswordModal = false;
    private bool showDeleteModal = false;
    private bool isEditing = false;
    private UserModel? selectedUser;
    private UserFormModel userForm = new();
    private PasswordFormModel passwordForm = new();
    private string? alertMessage;
    private bool alertSuccess;
    private string currentUsername = "Unknown";
    private string currentUserRole = "Admin";

    // Filters
    private string searchTerm = "";
    private string roleFilter = "";
    private string statusFilter = "";
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private int totalUsers = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        await LoadRoles();
        await LoadUsers();
        await AuditService.LogAsync("ViewUsers", currentUsername, currentUserRole, "User", null, "Accessed user management page", "/users");
    }

    private async Task LoadCurrentUser()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUsername = authState.User.Identity?.Name ?? "Unknown";
        currentUserRole = authState.User.Claims.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.Role)?.Value ??
        "Admin";
    }

    private async Task LoadRoles()
    {
        try
        {
            var roles = await UserService.GetRolesAsync();
            if (roles.Any())
            {
                availableRoles = roles;
            }
        }
        catch { }
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        try
        {
            var response = await UserService.GetUsersAsync(currentPage, pageSize, searchTerm, roleFilter, statusFilter);
            users = response.Users;
            totalUsers = response.TotalCount;
            totalPages = response.TotalPages;
        }
        catch (Exception ex)
        {
            ShowAlert($"Error loading users: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            currentPage = 1;
            await LoadUsers();
        }
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadUsers();
        }
    }

    private async Task ResetFilters()
    {
        searchTerm = "";
        roleFilter = "";
        statusFilter = "";
        currentPage = 1;
        await LoadUsers();
    }

    private void ShowCreateModal()
    {
        isEditing = false;
        userForm = new UserFormModel();
        showUserModal = true;
    }

    private void ShowEditModal(UserModel user)
    {
        isEditing = true;
        selectedUser = user;
        userForm = new UserFormModel
        {
            Id = user.Id,
            Username = user.Username,
            Email = user.Email,
            Role = user.Role
        };
        showUserModal = true;
    }

    private void CloseUserModal()
    {
        showUserModal = false;
        userForm = new();
        selectedUser = null;
    }

    private async Task SaveUser()
    {
        isSaving = true;
        try
        {
            if (isEditing)
            {
                await UserService.UpdateUserAsync(userForm.Id, userForm.Email, userForm.Role);
                ShowAlert($"User {userForm.Username} updated successfully", true);
                await AuditService.LogAsync("UpdateUser", currentUsername, currentUserRole, "User", userForm.Id.ToString(), $"Updated user: {userForm.Username}", "/users");
            }
            else
            {
                await UserService.CreateUserAsync(userForm.Username, userForm.Email, userForm.Password!, userForm.Role);
                ShowAlert($"User {userForm.Username} created successfully", true);
                await AuditService.LogAsync("CreateUser", currentUsername, currentUserRole, "User", null, $"Created user: {userForm.Username}", "/users");
            }
            CloseUserModal();
            await LoadUsers();
        }
        catch (Exception ex)
        {
            ShowAlert($"Error: {ex.Message}", false);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ShowPasswordModal(UserModel user)
    {
        selectedUser = user;
        passwordForm = new();
        showPasswordModal = true;
    }

    private void ClosePasswordModal()
    {
        showPasswordModal = false;
        passwordForm = new();
        selectedUser = null;
    }

    private async Task ChangePassword()
    {
        if (selectedUser == null) return;
        if (passwordForm.NewPassword != passwordForm.ConfirmPassword)
        {
            ShowAlert("Passwords do not match", false);
            return;
        }

        isSaving = true;
        try
        {
            await UserService.ChangePasswordAsync(selectedUser.Id, passwordForm.NewPassword!);
            ShowAlert($"Password changed for {selectedUser.Username}", true);
            await AuditService.LogAsync("ChangePassword", currentUsername, currentUserRole, "User", selectedUser.Id.ToString(),
            $"Changed password for: {selectedUser.Username}", "/users");
            ClosePasswordModal();
        }
        catch (Exception ex)
        {
            ShowAlert($"Error: {ex.Message}", false);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ConfirmDelete(UserModel user)
    {
        selectedUser = user;
        showDeleteModal = true;
    }

    private async Task DeleteUser()
    {
        if (selectedUser == null) return;

        isSaving = true;
        try
        {
            await UserService.DeleteUserAsync(selectedUser.Id);
            ShowAlert($"User {selectedUser.Username} deleted", true);
            await AuditService.LogAsync("DeleteUser", currentUsername, currentUserRole, "User", selectedUser.Id.ToString(),
            $"Deleted user: {selectedUser.Username}", "/users");
            showDeleteModal = false;
            selectedUser = null;
            await LoadUsers();
        }
        catch (Exception ex)
        {
            ShowAlert($"Error: {ex.Message}", false);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task UnlockUser(UserModel user)
    {
        try
        {
            await UserService.UnlockUserAsync(user.Id);
            ShowAlert($"User {user.Username} unlocked", true);
            await AuditService.LogAsync("UnlockUser", currentUsername, currentUserRole, "User", user.Id.ToString(), $"Unlocked user: {user.Username}", "/users");
            await LoadUsers();
        }
        catch (Exception ex)
        {
            ShowAlert($"Error: {ex.Message}", false);
        }
    }

    private async Task ActivateUser(UserModel user)
    {
        try
        {
            await UserService.ActivateUserAsync(user.Id);
            ShowAlert($"User {user.Username} activated", true);
            await AuditService.LogAsync("ActivateUser", currentUsername, currentUserRole, "User", user.Id.ToString(), $"Activated user: {user.Username}", "/users");
            await LoadUsers();
        }
        catch (Exception ex)
        {
            ShowAlert($"Error: {ex.Message}", false);
        }
    }

    private async Task DeactivateUser(UserModel user)
    {
        try
        {
            await UserService.DeactivateUserAsync(user.Id);
            ShowAlert($"User {user.Username} deactivated", true);
            await AuditService.LogAsync("DeactivateUser", currentUsername, currentUserRole, "User", user.Id.ToString(),
            $"Deactivated user: {user.Username}", "/users");
            await LoadUsers();
        }
        catch (Exception ex)
        {
            ShowAlert($"Error: {ex.Message}", false);
        }
    }

    private string GetRoleBadgeClass(string role) => role switch
    {
        "Admin" => "bg-danger",
        "Manager" => "bg-primary",
        "User" => "bg-info",
        "ReadOnly" => "bg-secondary",
        _ => "bg-secondary"
    };

    private void ShowAlert(string message, bool success)
    {
        alertMessage = message;
        alertSuccess = success;
        StateHasChanged();
        _ = Task.Delay(5000).ContinueWith(_ =>
        {
            alertMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }

    public class UserFormModel
    {
        public Guid Id { get; set; }
        [Required, StringLength(50, MinimumLength = 3)]
        public string Username { get; set; } = "";
        [Required, EmailAddress]
        public string Email { get; set; } = "";
        [StringLength(100, MinimumLength = 6)]
        public string? Password { get; set; }
        [Required]
        public string Role { get; set; } = "User";
    }

    public class PasswordFormModel
    {
        [Required, StringLength(100, MinimumLength = 6)]
        public string? NewPassword { get; set; }
        [Required, Compare(nameof(NewPassword))]
        public string? ConfirmPassword { get; set; }
    }
}